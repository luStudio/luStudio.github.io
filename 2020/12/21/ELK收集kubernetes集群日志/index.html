<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ELK收集kubernetes集群日志 | Lustudio</title><meta name="keywords" content="k8s"><meta name="author" content="Lustudio"><meta name="copyright" content="Lustudio"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包 运维主机HDSS7-200.host.com上：  Tomcat8下载链接 12345&#x2F;opt&#x2F;src[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-- 1 root root   9690027 Apr 10 22:57">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK收集kubernetes集群日志">
<meta property="og:url" content="http://example.com/2020/12/21/ELK%E6%94%B6%E9%9B%86kubernetes%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97/index.html">
<meta property="og:site_name" content="Lustudio">
<meta property="og:description" content="改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包 运维主机HDSS7-200.host.com上：  Tomcat8下载链接 12345&#x2F;opt&#x2F;src[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-- 1 root root   9690027 Apr 10 22:57">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-12-21T07:01:32.000Z">
<meta property="article:modified_time" content="2021-08-12T05:49:02.920Z">
<meta property="article:author" content="Lustudio">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/12/21/ELK%E6%94%B6%E9%9B%86kubernetes%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'ELK收集kubernetes集群日志',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-08-12 13:49:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQae-91xlO6GYrOzk-6P_ZgTFMVDGq7tliWjw&amp;usqp=CAU" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lustudio</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">ELK收集kubernetes集群日志</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-21T07:01:32.000Z" title="发表于 2020-12-21 15:01:32">2020-12-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-08-12T05:49:02.920Z" title="更新于 2021-08-12 13:49:02">2021-08-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="ELK收集kubernetes集群日志"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="改造dubbo-demo-web项目为Tomcat启动项目"><a href="#改造dubbo-demo-web项目为Tomcat启动项目" class="headerlink" title="改造dubbo-demo-web项目为Tomcat启动项目"></a>改造dubbo-demo-web项目为Tomcat启动项目</h2><p><a target="_blank" rel="noopener" href="http://tomcat.apache.org/">Tomcat官网</a></p>
<h2 id="准备Tomcat的镜像底包"><a href="#准备Tomcat的镜像底包" class="headerlink" title="准备Tomcat的镜像底包"></a>准备Tomcat的镜像底包</h2><h3 id="准备tomcat二进制包"><a href="#准备tomcat二进制包" class="headerlink" title="准备tomcat二进制包"></a>准备tomcat二进制包</h3><ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.40/bin/apache-tomcat-8.5.40.tar.gz">Tomcat8下载链接</a></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/src</span><br><span class="line">[root@hdss7-200 src]# ls -l|grep tomcat</span><br><span class="line">-rw-r--r-- 1 root root   9690027 Apr 10 22:57 apache-tomcat-8.5.46.tar.gz</span><br><span class="line">[root@hdss7-200 src]# mkdir -p /data/dockerfile/tomcat8 &amp;&amp; tar xf apache-tomcat-8.5.40.tar.gz -C /data/dockerfile/apache-tomcat-8.5.46</span><br><span class="line">[root@hdss7-200 src]# cd /data/dockerfile/apache-tomcat-8.5.46 &amp;&amp; rm -fr apache-tomcat-8.5.46/webapps/*</span><br></pre></td></tr></tbody></table></figure>


<h3 id="简单配置tomcat"><a href="#简单配置tomcat" class="headerlink" title="简单配置tomcat"></a>简单配置tomcat</h3><ol>
<li>关闭AJP端口</li>
</ol>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/tomcat/apache-tomcat-8.5.40/conf/server.xml</span><br><span class="line">&lt;!-- &lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443" /&gt; --&gt;</span><br></pre></td></tr></tbody></table></figure>


<ol start="2">
<li>配置日志</li>
</ol>
<ul>
<li>删除3manager，4host-manager的handlers</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/tomcat/apache-tomcat-8.5.40/conf/logging.properties</span><br><span class="line">handlers = 1catalina.org.apache.juli.AsyncFileHandler, 2localhost.org.apache.juli.AsyncFileHandler,java.util.logging.ConsoleHandler</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>日志级别改为INFO</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/tomcat/apache-tomcat-8.5.40/conf/logging.properties</span><br><span class="line">1catalina.org.apache.juli.AsyncFileHandler.level = INFO</span><br><span class="line">2localhost.org.apache.juli.AsyncFileHandler.level = INFO</span><br><span class="line">java.util.logging.ConsoleHandler.level = INFO</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>注释掉所有关于3manager，4host-manager日志的配置</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/tomcat/apache-tomcat-8.5.40/conf/logging.properties</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.level = FINE</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.prefix = manager.</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><br><span class="line"></span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.level = FINE</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.directory = ${catalina.base}/logs</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><br></pre></td></tr></tbody></table></figure>


<h3 id="准备Dockerfile"><a href="#准备Dockerfile" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/tomcat/Dockerfile</span><br><span class="line">From stanleyws/jre8:8u112</span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\ </span><br><span class="line">    echo 'Asia/Shanghai' &gt;/etc/timezone</span><br><span class="line">ENV CATALINA_HOME /opt/tomcat</span><br><span class="line">ENV LANG zh_CN.UTF-8</span><br><span class="line">ADD apache-tomcat-8.5.40/ /opt/tomcat</span><br><span class="line">ADD config.yml /opt/prom/config.yml</span><br><span class="line">ADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar</span><br><span class="line">WORKDIR /opt/tomcat</span><br><span class="line">ADD entrypoint.sh /entrypoint.sh</span><br><span class="line">CMD ["/entrypoint.sh"]</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>config.yml</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi config.yml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">rules:</span><br><span class="line">  - pattern: '.*'</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>jmx_javaagent-0.3.1.jar</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar -O jmx_javaagent-0.3.1.jar</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>entrypoint.sh</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vi entrypoint.sh (不要忘了给执行权限)</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">M_OPTS="-Duser.timezone=Asia/Shanghai -javaagent:/opt/prom/jmx_javaagent-0.3.1.jar=$(hostname -i):${M_PORT:-"12346"}:/opt/prom/config.yml"</span><br><span class="line">C_OPTS=${C_OPTS}</span><br><span class="line">MIN_HEAP=${MIN_HEAP:-"128m"}</span><br><span class="line">MAX_HEAP=${MAX_HEAP:-"128m"}</span><br><span class="line">JAVA_OPTS=${JAVA_OPTS:-"-Xmn384m -Xss256k -Duser.timezone=GMT+08  -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSClassUnloadingEnabled -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=80 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+PrintClassHistogram  -Dfile.encoding=UTF8 -Dsun.jnu.encoding=UTF8"}</span><br><span class="line">CATALINA_OPTS="${CATALINA_OPTS}"</span><br><span class="line">JAVA_OPTS="${M_OPTS} ${C_OPTS} -Xms${MIN_HEAP} -Xmx${MAX_HEAP} ${JAVA_OPTS}"</span><br><span class="line">sed -i -e "1a\JAVA_OPTS=\"$JAVA_OPTS\"" -e "1a\CATALINA_OPTS=\"$CATALINA_OPTS\"" /opt/tomcat/bin/catalina.sh</span><br><span class="line">cd /opt/tomcat &amp;&amp; /opt/tomcat/bin/catalina.sh run 2&gt;&amp;1 &gt;&gt; /opt/tomcat/logs/stdout.log</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<h3 id="制作镜像并推送"><a href="#制作镜像并推送" class="headerlink" title="制作镜像并推送"></a>制作镜像并推送</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 tomcat]# docker build . -t harbor.od.com/base/tomcat:v8.5.40</span><br><span class="line">Sending build context to Docker daemon 9.502 MB</span><br><span class="line">Step 1 : FROM stanleyws/jre8:8u112</span><br><span class="line"> ---&gt; fa3a085d6ef1</span><br><span class="line">Step 2 : RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo 'Asia/Shanghai' &gt;/etc/timezone</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5da5ab0b1a48</span><br><span class="line">Step 3 : ENV CATALINA_HOME /opt/tomcat</span><br><span class="line"> ---&gt; Running in edf8f2bbeae3</span><br><span class="line"> ---&gt; 05c7b829c8ab</span><br><span class="line">Removing intermediate container edf8f2bbeae3</span><br><span class="line">Step 4 : ENV LANG zh_CN.UTF-8</span><br><span class="line"> ---&gt; Running in 50516133f65b</span><br><span class="line"> ---&gt; 421d67c4c188</span><br><span class="line">Removing intermediate container 50516133f65b</span><br><span class="line">Step 5 : ADD apache-tomcat-8.5.40/ /opt/tomcat</span><br><span class="line"> ---&gt; 460a5d0ef93b</span><br><span class="line">Removing intermediate container 0be2b4897d23</span><br><span class="line">Step 6 : ADD config.yml /opt/prom/config.yml</span><br><span class="line"> ---&gt; 04c9d4679f0d</span><br><span class="line">Removing intermediate container 0e88a4ed2088</span><br><span class="line">Step 7 : ADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar</span><br><span class="line"> ---&gt; 06e4a78e9cbf</span><br><span class="line">Removing intermediate container 1e6b2919be00</span><br><span class="line">Step 8 : WORKDIR /opt/tomcat</span><br><span class="line"> ---&gt; Running in a51676d15a01</span><br><span class="line"> ---&gt; e8d164847eb3</span><br><span class="line">Removing intermediate container a51676d15a01</span><br><span class="line">Step 9 : ADD entrypoint.sh /entrypoint.sh</span><br><span class="line"> ---&gt; 0522db421536</span><br><span class="line">Removing intermediate container 7f0be318fde8</span><br><span class="line">Step 10 : CMD /entrypoint.sh</span><br><span class="line"> ---&gt; Running in c2df6e511c00</span><br><span class="line"> ---&gt; 8d735515bb42</span><br><span class="line">Removing intermediate container c2df6e511c00</span><br><span class="line">Successfully built 8d735515bb42</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 tomcat8]# docker push harbor.od.com/base/tomcat:v8.5.40</span><br><span class="line">The push refers to a repository [harbor.od.com/base/tomcat]</span><br><span class="line">498eaadf86a8: Pushed </span><br><span class="line">fab679acf269: Pushed </span><br><span class="line">0e65f86c3a75: Pushed </span><br><span class="line">938c8a5617cc: Pushed </span><br><span class="line">052016a734be: Mounted from app/dubbo-demo-web </span><br><span class="line">0690f10a63a5: Mounted from app/dubbo-demo-web </span><br><span class="line">c843b2cf4e12: Mounted from app/dubbo-demo-web </span><br><span class="line">fddd8887b725: Mounted from base/jre8 </span><br><span class="line">42052a19230c: Mounted from base/jre8 </span><br><span class="line">8d4d1ab5ff74: Mounted from base/jre8 </span><br><span class="line">v8.5.40: digest: sha256:407c6abd7c4fa5119376efa71090b49637d7a52ef2fc202f4019ab4c91f6dc50 size: 2409</span><br></pre></td></tr></tbody></table></figure>


<h2 id="改造dubbo-demo-web项目"><a href="#改造dubbo-demo-web项目" class="headerlink" title="改造dubbo-demo-web项目"></a>改造dubbo-demo-web项目</h2><h3 id="修改dubbo-client-pom-xml"><a href="#修改dubbo-client-pom-xml" class="headerlink" title="修改dubbo-client/pom.xml"></a>修改dubbo-client/pom.xml</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-web/dubbo-client/pom.xml</span><br><span class="line">&lt;packaging&gt;war&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">  &lt;exclusions&gt;</span><br><span class="line">    &lt;exclusion&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;</span><br><span class="line">    &lt;/exclusion&gt;</span><br><span class="line">  &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; </span><br><span class="line">  &lt;artifactId&gt;tomcat-servlet-api&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;8.0.36&lt;/version&gt;</span><br><span class="line">  &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure>


<h3 id="修改Application-java"><a href="#修改Application-java" class="headerlink" title="修改Application.java"></a>修改Application.java</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-web/dubbo-client/src/main/java/com/od/dubbotest/Application.java</span><br><span class="line">import org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line">import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line">import org.springframework.context.annotation.ImportResource;</span><br><span class="line"></span><br><span class="line">@ImportResource(value={"classpath*:spring-config.xml"})</span><br><span class="line">@EnableAutoConfiguration(exclude={DataSourceAutoConfiguration.class})</span><br></pre></td></tr></tbody></table></figure>


<h3 id="创建ServletInitializer-java"><a href="#创建ServletInitializer-java" class="headerlink" title="创建ServletInitializer.java"></a>创建ServletInitializer.java</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/d/workspace/dubbo-demo-web/dubbo-client/src/main/java/com/od/dubbotest/ServletInitializer.java</span><br><span class="line">package com.od.dubbotest;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.builder.SpringApplicationBuilder;</span><br><span class="line">import org.springframework.boot.context.web.SpringBootServletInitializer;</span><br><span class="line">import com.od.dubbotest.Application;</span><br><span class="line"></span><br><span class="line">public class ServletInitializer extends SpringBootServletInitializer {</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) {</span><br><span class="line">        return builder.sources(Application.class);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<h3 id="新建Jenkins的pipeline"><a href="#新建Jenkins的pipeline" class="headerlink" title="新建Jenkins的pipeline"></a>新建Jenkins的pipeline</h3><ul>
<li>配置New job</li>
<li>使用admin登录</li>
<li>New Item</li>
<li>create new jobs</li>
<li>Enter an item name</li>
</ul>
<blockquote>
<blockquote>
<p>tomcat-demo</p>
</blockquote>
</blockquote>
<ul>
<li><p>Pipeline -&gt; OK</p>
</li>
<li><p>Discard old builds</p>
</li>
</ul>
<blockquote>
<blockquote>
<p>Days to keep builds : 3<br>Max # of builds to keep : 30</p>
</blockquote>
</blockquote>
<ul>
<li>This project is parameterized</li>
</ul>
<ol>
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : app_name<br>Default Value :<br>Description : project name. e.g: dubbo-demo-web</p>
</blockquote>
</blockquote>
<ol start="2">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : image_name<br>Default Value :<br>Description : project docker image name. e.g: app/dubbo-demo-web</p>
</blockquote>
</blockquote>
<ol start="3">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : git_repo<br>Default Value :<br>Description : project git repository. e.g: <a href="mailto:git@gitee.com">git@gitee.com</a>:stanleywang/dubbo-demo-web.git</p>
</blockquote>
</blockquote>
<ol start="4">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : git_ver<br>Default Value : tomcat<br>Description : git commit id of the project.</p>
</blockquote>
</blockquote>
<ol start="5">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : add_tag<br>Default Value :<br>Description : project docker image tag, date_timestamp recommended. e.g: 190117_1920</p>
</blockquote>
</blockquote>
<ol start="6">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : mvn_dir<br>Default Value : ./<br>Description : project maven directory. e.g: ./</p>
</blockquote>
</blockquote>
<ol start="7">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : target_dir<br>Default Value : ./dubbo-client/target<br>Description : the relative path of target file such as .jar or .war package. e.g: ./dubbo-client/target</p>
</blockquote>
</blockquote>
<ol start="8">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : mvn_cmd<br>Default Value : mvn clean package -Dmaven.test.skip=true<br>Description : maven command. e.g: mvn clean package -e -q -Dmaven.test.skip=true</p>
</blockquote>
</blockquote>
<ol start="9">
<li>Add Parameter -&gt; Choice Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : base_image<br>Default Value :</p>
</blockquote>
</blockquote>
<ul>
<li>base/tomcat:v7.0.94</li>
<li>base/tomcat:v8.5.40</li>
<li>base/tomcat:v9.0.17</li>
<li>Description : project base image list in harbor.od.com.</li>
</ul>
<ol start="10">
<li>Add Parameter -&gt; Choice Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : maven<br>Default Value :</p>
</blockquote>
</blockquote>
<ul>
<li>3.6.0-8u181</li>
<li>3.2.5-6u025</li>
<li>2.2.1-6u025</li>
<li>Description : different maven edition.</li>
</ul>
<ol start="11">
<li>Add Parameter -&gt; String Parameter</li>
</ol>
<blockquote>
<blockquote>
<p>Name : root_url<br>Default Value : ROOT<br>Description : webapp dir.</p>
</blockquote>
</blockquote>
<p><img src="https://blog.stanley.wang/images/jenkins-2projects.png" alt="jenkins新增流水线"></p>
<h3 id="Pipeline-Script"><a href="#Pipeline-Script" class="headerlink" title="Pipeline Script"></a>Pipeline Script</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pipeline {</span><br><span class="line">  agent any </span><br><span class="line">    stages {</span><br><span class="line">    stage('pull') { //get project code from repo </span><br><span class="line">      steps {</span><br><span class="line">        sh "git clone ${params.git_repo} ${params.app_name}/${env.BUILD_NUMBER} &amp;&amp; cd ${params.app_name}/${env.BUILD_NUMBER} &amp;&amp; git checkout ${params.git_ver}"</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    stage('build') { //exec mvn cmd</span><br><span class="line">      steps {</span><br><span class="line">        sh "cd ${params.app_name}/${env.BUILD_NUMBER}  &amp;&amp; /var/jenkins_home/maven-${params.maven}/bin/${params.mvn_cmd}"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    stage('unzip') { //unzip  target/*.war -c target/project_dir</span><br><span class="line">      steps {</span><br><span class="line">        sh "cd ${params.app_name}/${env.BUILD_NUMBER} &amp;&amp; cd ${params.target_dir} &amp;&amp; mkdir project_dir &amp;&amp; unzip *.war -d ./project_dir"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    stage('image') { //build image and push to registry</span><br><span class="line">      steps {</span><br><span class="line">        writeFile file: "${params.app_name}/${env.BUILD_NUMBER}/Dockerfile", text: """FROM harbor.od.com/${params.base_image}</span><br><span class="line">ADD ${params.target_dir}/project_dir /opt/tomcat/webapps/${params.root_url}"""</span><br><span class="line">        sh "cd  ${params.app_name}/${env.BUILD_NUMBER} &amp;&amp; docker build -t harbor.od.com/${params.image_name}:${params.git_ver}_${params.add_tag} . &amp;&amp; docker push harbor.od.com/${params.image_name}:${params.git_ver}_${params.add_tag}"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<h3 id="构建应用镜像"><a href="#构建应用镜像" class="headerlink" title="构建应用镜像"></a>构建应用镜像</h3><ul>
<li>使用Jenkins进行CI，并查看harbor仓库<br><img src="https://blog.stanley.wang/images/jenkins-tomcat.png" alt="jenkins构建"><br><img src="https://blog.stanley.wang/images/harbor-tomcat.png" alt="harbor仓库"></li>
</ul>
<h3 id="准备k8s的资源配置清单"><a href="#准备k8s的资源配置清单" class="headerlink" title="准备k8s的资源配置清单"></a>准备k8s的资源配置清单</h3><ul>
<li>不再需要单独准备资源配置清单</li>
</ul>
<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><ul>
<li>k8s的dashboard上直接修改image的值为jenkins打包出来的镜像</li>
<li>文档里的例子是：harbor.od.com/app/dubbo-demo-web:tomcat_190119_1920</li>
</ul>
<h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><ul>
<li><a target="_blank" rel="noopener" href="http://demo.od.com/?hello=wangdao">http://demo.od.com?hello=wangdao</a></li>
</ul>
<h3 id="检查tomcat运行情况"><a href="#检查tomcat运行情况" class="headerlink" title="检查tomcat运行情况"></a>检查tomcat运行情况</h3><ul>
<li>任意一台运算节点主机上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# kubectl get pods -n app</span><br><span class="line">NAME                                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">dubbo-demo-consumer-v025-htfx8                          2/2       Running   0          1h</span><br><span class="line">[root@hdss7-22 ~]# kubectl exec -ti dubbo-demo-consumer-v025-htfx8 -n app bash</span><br><span class="line">dubbo-demo-consumer-v025-htfx8:/opt/tomcat#  ls -lsr logs/</span><br><span class="line">total 16</span><br><span class="line">-rw-r----- 1 root root 7435 Jan 19 19:26 catalina.2019-01-19.log</span><br><span class="line">-rw-r----- 1 root root  629 Jan 19 19:26 localhost.2019-01-19.log</span><br><span class="line">-rw-r----- 1 root root  249 Jan 15 19:27 localhost_access_log.2019-01-19.txt</span><br></pre></td></tr></tbody></table></figure>
<h2 id="elk简介"><a href="#elk简介" class="headerlink" title="elk简介"></a>elk简介</h2><ul>
<li>收集<ul>
<li>能够采集多种来源的日志数据（流式日志收集器） 9200 http    9300 tcp socket</li>
</ul>
</li>
<li>传输<ul>
<li>能够稳定的吧日志数据传输到中央系统（消息队列）</li>
</ul>
</li>
<li>存储<ul>
<li>可以将日志以结构化数据的形式存储起来（搜索引擎）</li>
</ul>
</li>
<li>分析<ul>
<li>支持方便的分析，检索方法，最好的GUI管理器（前端）、</li>
</ul>
</li>
<li>警告<ul>
<li>能够提供错误报告，监控机制（监控工具）      </li>
</ul>
</li>
</ul>
<h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><hr>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>kafka</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>ElasticSearch</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-200.host.com</td>
<td>kafka-manager filebeat logstash Kibana</td>
<td>10.4.7.200</td>
</tr>
</tbody></table>
<h3 id="部署ElasticSearch"><a href="#部署ElasticSearch" class="headerlink" title="部署ElasticSearch"></a>部署ElasticSearch</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.elastic.co/">官网</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch">官方github地址</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.6.tar.gz">下载地址</a></p>
</li>
<li><p>HDSS7-12.host.com上：</p>
</li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/src</span><br><span class="line">[root@hdss7-12 src]# ls -l|grep elasticsearch-6.8.6.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root  72262257 Jan 30 15:18 elasticsearch-6.8.6.tar.gz</span><br><span class="line">[root@hdss7-12 src]# tar xf elasticsearch-6.8.6.tar.gz -C /opt</span><br><span class="line">[root@hdss7-12 src]# ln -s /opt/elasticsearch-6.8.6/ /opt/elasticsearch</span><br></pre></td></tr></tbody></table></figure>


<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch.yml</span><br><span class="line">[root@hdss7-12 src]# mkdir -p /data/elasticsearch/{data,logs}</span><br><span class="line">[root@hdss7-12 elasticsearch]# vi config/elasticsearch.yml</span><br><span class="line">cluster.name: es.od.com</span><br><span class="line">node.name: hdss7-12.host.com</span><br><span class="line">path.data: /data/elasticsearch/data</span><br><span class="line">path.logs: /data/elasticsearch/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 10.4.7.12</span><br><span class="line">http.port: 9200</span><br></pre></td></tr></tbody></table></figure>


<h3 id="jvm-options"><a href="#jvm-options" class="headerlink" title="jvm.options"></a>jvm.options</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# vi config/jvm.options</span><br><span class="line">-Xms512m</span><br><span class="line">-Xmx512m</span><br></pre></td></tr></tbody></table></figure>


<h3 id="创建普通用户"><a href="#创建普通用户" class="headerlink" title="创建普通用户"></a>创建普通用户</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# useradd -s /bin/bash -M es</span><br><span class="line">[root@hdss7-12 elasticsearch]# chown -R es.es /opt/elasticsearch-5.6.15</span><br><span class="line">[root@hdss7-12 elasticsearch]# chown -R es.es /data/elasticsearch</span><br></pre></td></tr></tbody></table></figure>


<h3 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/security/limits.d/es.conf</span><br><span class="line">es hard nofile 65536</span><br><span class="line">es soft fsize unlimited</span><br><span class="line">es hard memlock unlimited</span><br><span class="line">es soft memlock unlimited</span><br></pre></td></tr></tbody></table></figure>


<h3 id="调整内核参数"><a href="#调整内核参数" class="headerlink" title="调整内核参数"></a>调整内核参数</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# sysctl -w vm.max_map_count=262144</span><br><span class="line">or</span><br><span class="line">[root@hdss7-12 elasticsearch]# echo "vm.max_map_count=262144" &gt; /etc/sysctl.conf</span><br><span class="line">[root@hdss7-12 elasticsearch]# sysctl -p</span><br></pre></td></tr></tbody></table></figure>


<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# su - es</span><br><span class="line">su: warning: cannot change directory to /home/es: No such file or directory</span><br><span class="line">-bash-4.2$ /opt/elasticsearch/bin/elasticsearch &amp;</span><br><span class="line">[1] 8714</span><br><span class="line">[root@hdss7-12 elasticsearch]# ps -ef|grep elastic|grep -v grep</span><br><span class="line">es        8714     1 58 10:29 pts/0    00:00:19 /usr/java/jdk/bin/java -Xms512m -Xmx512m -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -Djdk.io.permissionsUseCanonicalPath=true -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Dlog4j.skipJansi=true -XX:+HeapDumpOnOutOfMemoryError -Des.path.home=/opt/elasticsearch -cp /opt/elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch</span><br></pre></td></tr></tbody></table></figure>


<h3 id="调整ES日志模板"><a href="#调整ES日志模板" class="headerlink" title="调整ES日志模板"></a>调整ES日志模板</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# curl -H "Content-Type:application/json" -XPUT http://10.4.7.12:9200/_template/k8s -d '{</span><br><span class="line">  "template" : "k8s*",</span><br><span class="line">  "index_patterns": ["k8s*"],  </span><br><span class="line">  "settings": {</span><br><span class="line">    "number_of_shards": 5,</span><br><span class="line">    "number_of_replicas": 0</span><br><span class="line">  }</span><br><span class="line">}'</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<h2 id="部署kafka"><a href="#部署kafka" class="headerlink" title="部署kafka"></a>部署kafka</h2><ul>
<li><a target="_blank" rel="noopener" href="http://kafka.apache.org/">官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/apache/kafka">官方github地址</a></li>
<li><a target="_blank" rel="noopener" href="http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.1.1/kafka_2.12-2.1.1.tgz">下载地址</a></li>
<li>HDSS7-11.host.com上：</li>
</ul>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/src</span><br><span class="line">[root@hdss7-11 src]# ls -l|grep kafka</span><br><span class="line">-rw-r--r-- 1 root root  57028557 Mar 23 08:57 kafka_2.12-2.2.0.tgz</span><br><span class="line">[root@hdss7-11 src]# tar xf kafka_2.12-2.1.1.tgz -C /opt</span><br><span class="line">[root@hdss7-11 src]# ln -s /opt/kafka_2.12-2.1.1/ /opt/kafka</span><br></pre></td></tr></tbody></table></figure>


<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log.dirs=/data/kafka/logs</span><br><span class="line">zookeeper.connect=localhost:2181</span><br><span class="line">log.flush.interval.messages=10000</span><br><span class="line">log.flush.interval.ms=1000</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">host.name=hdss7-11.host.com</span><br></pre></td></tr></tbody></table></figure>


<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/kafka</span><br><span class="line">[root@hdss7-11 kafka]# bin/kafka-server-start.sh -daemon config/server.properties</span><br><span class="line">[root@hdss7-11 kafka]# netstat -luntp|grep 9092</span><br><span class="line">tcp6       0      0 10.4.7.12:9092         :::*                    LISTEN      17543/java</span><br></pre></td></tr></tbody></table></figure>


<h2 id="部署kafka-manager"><a href="#部署kafka-manager" class="headerlink" title="部署kafka-manager"></a>部署kafka-manager</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/yahoo/kafka-manager">官方github地址</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/yahoo/kafka-manager/archive/2.0.0.2.tar.gz">源码下载地址</a></li>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<h3 id="方法一：1、准备Dockerfile"><a href="#方法一：1、准备Dockerfile" class="headerlink" title="方法一：1、准备Dockerfile"></a>方法一：1、准备Dockerfile</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/kafka-manager/Dockerfile</span><br><span class="line">FROM hseeberger/scala-sbt</span><br><span class="line"></span><br><span class="line">ENV ZK_HOSTS=10.4.7.11:2181 \</span><br><span class="line">     KM_VERSION=3.0.0.4</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /tmp &amp;&amp; \</span><br><span class="line">    cd /tmp &amp;&amp; \</span><br><span class="line">    wget https://github.com/yahoo/CMAK/archive/${KM_VERSION}.tar.gz &amp;&amp; \</span><br><span class="line">    tar xxf ${KM_VERSION}.tar.gz &amp;&amp; \</span><br><span class="line">    cd /tmp/CMAK-${KM_VERSION} &amp;&amp; \</span><br><span class="line">    sbt clean dist &amp;&amp; \</span><br><span class="line">    unzip  -d / ./target/universal/CMAK-${KM_VERSION}.zip &amp;&amp; \</span><br><span class="line">    rm -fr /tmp/${KM_VERSION} /tmp/CMAK-${KM_VERSION}</span><br><span class="line"></span><br><span class="line">WORKDIR /CMAK-${KM_VERSION}</span><br><span class="line"></span><br><span class="line">EXPOSE 9000</span><br><span class="line">ENTRYPOINT ["./bin/CMAK","-Dconfig.file=conf/application.conf"]</span><br></pre></td></tr></tbody></table></figure>


<h3 id="方法一：2、制作docker镜像"><a href="#方法一：2、制作docker镜像" class="headerlink" title="方法一：2、制作docker镜像"></a>方法一：2、制作docker镜像</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/kafka-manager</span><br><span class="line">[root@hdss7-200 kafka-manager]# docker build . -t harbor.od.com/infra/kafka-manager:v2.0.0.2</span><br><span class="line">(漫长的过程)</span><br></pre></td></tr></tbody></table></figure>


<h3 id="方法二：直接下载docker镜像"><a href="#方法二：直接下载docker镜像" class="headerlink" title="方法二：直接下载docker镜像"></a>方法二：直接下载docker镜像</h3><ul>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/stanleyws/kafka-manager:v2.0.0.2">镜像下载地址</a></li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull stanleyws/kafka-manager:v2.0.0.2</span><br><span class="line">[root@hdss7-200 ~]# docker tag 34627743836f harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">docker push harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/kafka]</span><br><span class="line">ef97dbc2670b: Pushed </span><br><span class="line">ec01aa005e59: Pushed </span><br><span class="line">de05a1bdf878: Pushed </span><br><span class="line">9c553f3feafd: Pushed </span><br><span class="line">581533427a4f: Pushed </span><br><span class="line">f6b229974fdd: Pushed </span><br><span class="line">ae150883d6e2: Pushed </span><br><span class="line">3df7be729841: Pushed </span><br><span class="line">f231cc200afe: Pushed </span><br><span class="line">9752c15164a8: Pushed </span><br><span class="line">9ab7eda5c826: Pushed </span><br><span class="line">402964b3d72e: Pushed </span><br><span class="line">6b3f8ebf864c: Pushed </span><br><span class="line">stable: digest: sha256:57fd46a3751284818f1bc6c0fdf097250bc0feed03e77135fb8b0a93aa8c6cc7 size: 3056</span><br></pre></td></tr></tbody></table></figure>


<h3 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li>Deployment </li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/kafka-manager/deployment.yaml</span><br><span class="line"></span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kafka-manager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      app: kafka-manager</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kafka-manager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kafka-manager</span><br><span class="line">        image: harbor.od.com/infra/kafka-manager:v2.0.0.2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ZK_HOSTS</span><br><span class="line">          value: zk1.od.com:2181</span><br><span class="line">        - name: APPLICATION_SECRET</span><br><span class="line">          value: letmein</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/kafka-manager/svc.yaml</span><br><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9000</span><br><span class="line">    targetPort: 9000</span><br><span class="line">    selector: </span><br><span class="line">    app: kafka-manager</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Ingress</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/kafka-manager/ingress.yaml</span><br><span class="line"></span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: km.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kafka-manager</span><br><span class="line">          servicePort: 9000</span><br></pre></td></tr></tbody></table></figure>
<h3 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><ul>
<li>任意一台运算节点上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/deployment.yaml </span><br><span class="line">deployment.extensions/kafka-manager created</span><br><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/svc.yaml </span><br><span class="line">service/kafka-manager created</span><br><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/ingress.yaml </span><br><span class="line">ingress.extensions/kafka-manager created</span><br></pre></td></tr></tbody></table></figure>


<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><ul>
<li>HDSS7-11.host.com上</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/named/od.com.zone</span><br><span class="line">km	60 IN A 10.4.7.10</span><br></pre></td></tr></tbody></table></figure>


<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><ul>
<li><a target="_blank" rel="noopener" href="http://km.od.com/">http://km.od.com</a></li>
</ul>
<p><img src="https://blog.stanley.wang/images/kafka-manager.png" alt="kafka-manager"></p>
<h2 id="部署filebeat"><a href="#部署filebeat" class="headerlink" title="部署filebeat"></a>部署filebeat</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/downloads/beats/filebeat">官方下载地址</a></p>
<ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<h3 id="制作docker镜像"><a href="#制作docker镜像" class="headerlink" title="制作docker镜像"></a>制作docker镜像</h3><h3 id="准备Dockerfile-1"><a href="#准备Dockerfile-1" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h3><ul>
<li>Dockerfile</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi /data/dockerfile/filebeat/Dockerfile</span><br><span class="line"></span><br><span class="line">FROM debian:jessie</span><br><span class="line">ENV FILEBEAT_VERSION=7.4.0 \</span><br><span class="line">    FILEBEAT_SHA1=c63bb1e16f7f85f71568041c78f11b57de58d497ba733e398fa4b2d071270a86dbab19d5cb35da5d3579f35cb5b5f3c46e6e08cdf840afb7c347777aae5c4e11</span><br><span class="line">RUN set -x &amp;&amp; \</span><br><span class="line">  apt-get update &amp;&amp; \</span><br><span class="line">  apt-get install -y wget &amp;&amp; \</span><br><span class="line">  wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-${FILEBEAT_VERSION}-linux-x86_64.tar.gz -O /opt/filebeat.tar.gz &amp;&amp; \</span><br><span class="line">  cd /opt &amp;&amp; \</span><br><span class="line">  echo "${FILEBEAT_SHA1}  filebeat.tar.gz" | sha512sum -c - &amp;&amp; \</span><br><span class="line">  tar xzvf filebeat.tar.gz &amp;&amp; \</span><br><span class="line">  cd filebeat-* &amp;&amp; \</span><br><span class="line">  cp filebeat /bin &amp;&amp; \</span><br><span class="line">  cd /opt &amp;&amp; \</span><br><span class="line">  rm -rf filebeat* &amp;&amp; \</span><br><span class="line">  apt-get purge -y wget &amp;&amp; \</span><br><span class="line">  apt-get autoremove -y &amp;&amp; \</span><br><span class="line">  apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</span><br><span class="line"></span><br><span class="line">COPY docker-entrypoint.sh /</span><br><span class="line">ENTRYPOINT ["/docker-entrypoint.sh"]</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>Entrypoint</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">vi /data/dockerfile/filebeat/docker-entrypoint.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">ENV=${ENV:-"test"}</span><br><span class="line">PROJ_NAME=${PROJ_NAME:-"no-define"}</span><br><span class="line">MULTILINE=${MULTILINE:-"^\d{2}"}</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/filebeat.yaml &lt;&lt; EOF</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logm-${PROJ_NAME}</span><br><span class="line">  paths:</span><br><span class="line">    - /logm/*.log</span><br><span class="line">    - /logm/*/*.log</span><br><span class="line">    - /logm/*/*/*.log</span><br><span class="line">    - /logm/*/*/*/*.log</span><br><span class="line">    - /logm/*/*/*/*/*.log</span><br><span class="line">  scan_frequency: 120s</span><br><span class="line">  max_bytes: 10485760</span><br><span class="line">  multiline.pattern: '$MULTILINE'</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.max_lines: 100</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logu-${PROJ_NAME}</span><br><span class="line">  paths:</span><br><span class="line">    - /logu/*.log</span><br><span class="line">    - /logu/*/*.log</span><br><span class="line">    - /logu/*/*/*.log</span><br><span class="line">    - /logu/*/*/*/*.log</span><br><span class="line">    - /logu/*/*/*/*/*.log</span><br><span class="line">    - /logu/*/*/*/*/*/*.log</span><br><span class="line">output.kafka:</span><br><span class="line">  hosts: ["10.4.7.11:9092"]</span><br><span class="line">  topic: k8s-fb-$ENV-%{[topic]}</span><br><span class="line">  version: 2.0.0</span><br><span class="line">  required_acks: 0</span><br><span class="line">  max_message_bytes: 10485760</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">set -xe</span><br><span class="line"></span><br><span class="line"># If user don't provide any command</span><br><span class="line"># Run filebeat</span><br><span class="line">if [[ "$1" == "" ]]; then</span><br><span class="line">     exec filebeat  -c /etc/filebeat.yaml </span><br><span class="line">else</span><br><span class="line">    # Else allow the user to run arbitrarily commands like bash</span><br><span class="line">    exec "$@"</span><br><span class="line">fi</span><br></pre></td></tr></tbody></table></figure>


<h3 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/filebeat</span><br><span class="line">[root@hdss7-200 filebeat]# docker build . -t harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">...</span><br><span class="line">+ apt-get autoremove -y</span><br><span class="line">Reading package lists...</span><br><span class="line">Building dependency tree...</span><br><span class="line">Reading state information...</span><br><span class="line">The following packages will be REMOVED:</span><br><span class="line">  ca-certificates libicu52 libidn11 libpsl0 libssl1.0.0 openssl</span><br><span class="line">0 upgraded, 0 newly installed, 6 to remove and 6 not upgraded.</span><br><span class="line">After this operation, 33.6 MB disk space will be freed.</span><br><span class="line">(Reading database ... 7962 files and directories currently installed.)</span><br><span class="line">Removing ca-certificates (20141019+deb8u4) ...</span><br><span class="line">Removing dangling symlinks from /etc/ssl/certs... done.</span><br><span class="line">Removing libpsl0:amd64 (0.5.1-1) ...</span><br><span class="line">Removing libicu52:amd64 (52.1-8+deb8u7) ...</span><br><span class="line">Removing libidn11:amd64 (1.29-1+deb8u3) ...</span><br><span class="line">Removing openssl (1.0.1t-1+deb8u11) ...</span><br><span class="line">Removing libssl1.0.0:amd64 (1.0.1t-1+deb8u11) ...</span><br><span class="line">Processing triggers for libc-bin (2.19-18+deb8u10) ...</span><br><span class="line">+ apt-get clean</span><br><span class="line">+ rm -rf /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_Release /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_Release.gpg /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_main_binary-amd64_Packages.gz /var/lib/apt/lists/lock /var/lib/apt/lists/partial /var/lib/apt/lists/security.debian.org_debian-security_dists_jessie_updates_InRelease /var/lib/apt/lists/security.debian.org_debian-security_dists_jessie_updates_main_binary-amd64_Packages.gz /tmp/* /var/tmp/*</span><br><span class="line"> ---&gt; a78678659f2c</span><br><span class="line">Removing intermediate container 2cfff130c15c</span><br><span class="line">Step 4 : COPY docker-entrypoint.sh /</span><br><span class="line"> ---&gt; 62dc7fe5a98f</span><br><span class="line">Removing intermediate container 87e271482593</span><br><span class="line">Step 5 : ENTRYPOINT /docker-entrypoint.sh</span><br><span class="line"> ---&gt; Running in d367b6e3bb5a</span><br><span class="line"> ---&gt; 23c8fbdc088a</span><br><span class="line">Removing intermediate container d367b6e3bb5a</span><br><span class="line">Successfully built 23c8fbdc088a</span><br><span class="line">[root@hdss7-200 filebeat]# docker tag 23c8fbdc088a harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">[root@hdss7-200 filebeat]# docker push !$</span><br><span class="line">docker push harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/filebeat]</span><br><span class="line">6a765e653161: Pushed </span><br><span class="line">8e89ae5c6fc2: Pushed </span><br><span class="line">9abb3997a540: Pushed </span><br><span class="line">v7.0.1: digest: sha256:c35d7cdba29d8555388ad41ac2fc1b063ed9ec488082e33b5d0e91864b3bb35c size: 948</span><br></pre></td></tr></tbody></table></figure>


<h3 id="修改资源配置清单"><a href="#修改资源配置清单" class="headerlink" title="修改资源配置清单"></a>修改资源配置清单</h3><h3 id="使用dubbo-demo-consumer的Tomcat版镜像"><a href="#使用dubbo-demo-consumer的Tomcat版镜像" class="headerlink" title="使用dubbo-demo-consumer的Tomcat版镜像"></a>使用dubbo-demo-consumer的Tomcat版镜像</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">/data/k8s-yaml/dubbo-demo-consumer/deployment.yaml</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: test</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-web:tomcat</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv=fat -Dapollo.meta=http://config.od.com</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /opt/tomcat/logs</span><br><span class="line">          name: logm</span><br><span class="line">      - name: filebeat</span><br><span class="line">        image: harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: ENV</span><br><span class="line">          value: test</span><br><span class="line">        - name: PROJ_NAME</span><br><span class="line">          value: dubbo-demo-web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /logm</span><br><span class="line">          name: logm</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: {}</span><br><span class="line">        name: logm</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></tbody></table></figure>


<h3 id="浏览器访问http-km-od-com"><a href="#浏览器访问http-km-od-com" class="headerlink" title="浏览器访问http://km.od.com"></a>浏览器访问<a target="_blank" rel="noopener" href="http://km.od.com/">http://km.od.com</a></h3><ul>
<li>看到kafaka-manager里，topic打进来，即为成功。<br><img src="https://blog.stanley.wang/images/kafka-topic.png" alt="kafka-topic"></li>
</ul>
<h3 id="验证数据"><a href="#验证数据" class="headerlink" title="验证数据"></a>验证数据</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/opt/kafka/bin</span><br><span class="line">./kafka-console-consumer.sh --bootstrap-server 10.9.6.200:9092 --topic k8s-fb-test-logm-dubbo-demo-web --from-beginning</span><br></pre></td></tr></tbody></table></figure>


<h2 id="部署logstash"><a href="#部署logstash" class="headerlink" title="部署logstash"></a>部署logstash</h2><ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<h3 id="选版本"><a href="#选版本" class="headerlink" title="选版本"></a>选版本</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/support/matrix">logstash选型</a></li>
</ul>
<p><img src="https://blog.stanley.wang/images/es-logstash.png"></p>
<h3 id="准备docker镜像"><a href="#准备docker镜像" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h3><ul>
<li>下载官方镜像</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull logstash:6.7.2</span><br><span class="line">6.7.2: Pulling from library/logstash</span><br><span class="line">8ba884070f61: Pull complete </span><br><span class="line">063405b57b96: Pull complete </span><br><span class="line">0a0115b8825c: Pull complete </span><br><span class="line">825b124900cb: Pull complete </span><br><span class="line">ed736d9e3c41: Pull complete </span><br><span class="line">6efb3934697a: Pull complete </span><br><span class="line">c0a3a0c8ebc2: Pull complete </span><br><span class="line">f55d8adfbc3d: Pull complete </span><br><span class="line">3a6c56fbbef8: Pull complete </span><br><span class="line">ca45dc8946a2: Pull complete </span><br><span class="line">8b852a079ea9: Pull complete </span><br><span class="line">Digest: sha256:46eaff19af5e14edd9b78e1d5bf16f6abcd9ad50e0338cbaf3024f2aadb2903b</span><br><span class="line">Status: Downloaded newer image for logstash:6.7.2</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# docker tag 857d9a1f8221 harbor.od.com/public/logstash:v6.7.2</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">docker push harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">The push refers to a repository [harbor.od.com/public/logstash]</span><br><span class="line">c2b00f70cade: Mounted from public/filebeat </span><br><span class="line">9a2c2851596d: Mounted from public/filebeat </span><br><span class="line">86564f3ca0e2: Mounted from public/filebeat </span><br><span class="line">e9bc8faf823a: Mounted from public/filebeat </span><br><span class="line">3f3bcfa85067: Mounted from public/filebeat </span><br><span class="line">65d3b56913bd: Mounted from public/filebeat </span><br><span class="line">9b48a60607ee: Mounted from public/filebeat </span><br><span class="line">df859db41dd0: Mounted from public/filebeat </span><br><span class="line">1cbe912d7c00: Mounted from public/filebeat </span><br><span class="line">ab5fbaca7e70: Mounted from public/filebeat </span><br><span class="line">d69483a6face: Mounted from public/filebeat </span><br><span class="line">v6.7.2: digest: sha256:6aacf97dfbcc5c64c2f1a12f43ee48a8dadb98657b9b8d4149d0fee0ec18be81 size: 2823</span><br></pre></td></tr></tbody></table></figure>


<h3 id="自定义Dockerfile"><a href="#自定义Dockerfile" class="headerlink" title="自定义Dockerfile"></a>自定义Dockerfile</h3><ul>
<li>Dockerfile</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">From harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">ADD logstash.yml /usr/share/logstash/config</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>logstash.yml</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http.host: "0.0.0.0"</span><br><span class="line">path.config: /etc/logstash</span><br><span class="line">xpack.monitoring.enabled: false</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>创建自定义镜像</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/data/dockerfile/logstash</span><br><span class="line">[root@hdss7-200 logstash]# docker build . -t harbor.od.com/infra/logstash:v6.7.2</span><br><span class="line">Sending build context to Docker daemon 249.3 MB</span><br><span class="line">Step 1 : FROM harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">v6.7.2: Pulling from public/logstash</span><br><span class="line">e60be144a6a5: Pull complete </span><br><span class="line">6292c2b22d35: Pull complete </span><br><span class="line">1bb4586d90e7: Pull complete </span><br><span class="line">3f11f6d21132: Pull complete </span><br><span class="line">f0aaeeafebd3: Pull complete </span><br><span class="line">38c751a91f0f: Pull complete </span><br><span class="line">b80e2bad9681: Pull complete </span><br><span class="line">e3c97754ddde: Pull complete </span><br><span class="line">840f2d82a9fb: Pull complete </span><br><span class="line">32063a9aaefb: Pull complete </span><br><span class="line">e87b22bf50f5: Pull complete </span><br><span class="line">Digest: sha256:6aacf97dfbcc5c64c2f1a12f43ee48a8dadb98657b9b8d4149d0fee0ec18be81</span><br><span class="line">Status: Downloaded newer image for harbor.od.com/public/logstash:v6.7.2</span><br><span class="line"> ---&gt; 857d9a1f8221</span><br><span class="line">Step 2 : ADD logstash.yml /usr/share/logstash/config</span><br><span class="line"> ---&gt; 2ad32d3f5fef</span><br><span class="line">Removing intermediate container 1d3a1488c1b7</span><br><span class="line">Successfully built 2ad32d3f5fef</span><br><span class="line">[root@hdss7-200 logstash]# docker push harbor.od.com/infra/logstash:v6.7.2</span><br></pre></td></tr></tbody></table></figure>


<h3 id="启动docker镜像"><a href="#启动docker镜像" class="headerlink" title="启动docker镜像"></a>启动docker镜像</h3><ul>
<li>创建配置</li>
<li>hdss7-200.host.com</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/logstash/ </span><br><span class="line">vim /etc/logstash/logstash-test.conf</span><br><span class="line">input {</span><br><span class="line">  kafka {</span><br><span class="line">    bootstrap_servers =&gt; "10.4.7.11:9092"</span><br><span class="line">    client_id =&gt; "10.4.7.200"</span><br><span class="line">    consumer_threads =&gt; 4</span><br><span class="line">    group_id =&gt; "k8s_test"</span><br><span class="line">    topics_pattern =&gt; "k8s-fb-test-.*"</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">filter {</span><br><span class="line">  json {</span><br><span class="line">    source =&gt; "message"</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">output {</span><br><span class="line">  elasticsearch {</span><br><span class="line">    hosts =&gt; ["10.4.7.12:9200"]</span><br><span class="line">    index =&gt; "k8s-test-%{+YYYY.MM.DD}"</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<h3 id="启动logstash镜像"><a href="#启动logstash镜像" class="headerlink" title="启动logstash镜像"></a>启动logstash镜像</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker run -d --name logstash-test -v /etc/logstash:/etc/logstash harbor.od.com/infra/logstash:v6.7.2 -f /etc/logstash/logstash-test.conf</span><br><span class="line">[root@hdss7-200 ~]# docker ps -a|grep logstash</span><br><span class="line">a5dcf56faa9a        harbor.od.com/infra/logstash:v6.7.2                                                                                "/usr/local/bin/docke"   8 seconds ago       Up 6 seconds                5044/tcp, 9600/tcp           jovial_swanson</span><br></pre></td></tr></tbody></table></figure>


<h3 id="验证ElasticSearch里的索引"><a href="#验证ElasticSearch里的索引" class="headerlink" title="验证ElasticSearch里的索引"></a>验证ElasticSearch里的索引</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# curl http://10.4.7.12:9200/_cat/indices?v</span><br><span class="line">health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   k8s-test-2019.04 H3MY9d8WSbqQ6uL0DFhenQ   5   0         55            0    249.9kb        249.9kb</span><br></pre></td></tr></tbody></table></figure>


<h2 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h2><ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<h3 id="准备docker镜像-1"><a href="#准备docker镜像-1" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h3><ul>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/_/kibana?tab=tags">kibana官方镜像下载地址</a></li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull kibana:5.6.16</span><br><span class="line">5.6.16: Pulling from library/kibana</span><br><span class="line"></span><br><span class="line">8014725ed6f5: Pull complete </span><br><span class="line">19b590251e94: Pull complete </span><br><span class="line">7fa3e54c0b5a: Pull complete </span><br><span class="line">60ee9811b356: Pull complete </span><br><span class="line">d18bafa420f4: Pull complete </span><br><span class="line">8cee55751899: Pull complete </span><br><span class="line">c395be470eb2: Pull complete </span><br><span class="line">Digest: sha256:71f776596244877597fd679b2fa6fb0f1fa9c5b11388199997781d1ce77b73b1</span><br><span class="line">Status: Downloaded newer image for kibana:5.6.16</span><br><span class="line">[root@hdss7-200 ~]# docker tag 62079cf74c23 harbor.od.com/infra/kibana:v5.6.16</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/kibana:v5.6.16</span><br><span class="line">docker push harbor.od.com/infra/kibana:v5.6.16</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/kibana]</span><br><span class="line">be94745c5390: Pushed </span><br><span class="line">652dcbd52cdd: Pushed </span><br><span class="line">a3508a095ca7: Pushed </span><br><span class="line">56d52080e2fe: Pushed </span><br><span class="line">dbce28d91bf0: Pushed </span><br><span class="line">dcddc432ebdf: Pushed </span><br><span class="line">3e466685bf43: Pushed </span><br><span class="line">d69483a6face: Mounted from infra/logstash </span><br><span class="line">v5.6.16: digest: sha256:17dd243d6cc4e572f74f3de83eafc981e54c1710f8fe2d0bf74357b28bddaf08 size: 1991</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><ul>
<li>HDSS7-11.host.com上</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/named/od.com.zone</span><br><span class="line">kibana	60 IN A 10.4.7.10</span><br></pre></td></tr></tbody></table></figure>


<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li>Deploymnet</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/kibana/deployment.yaml</span><br><span class="line"></span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kibana</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kibana</span><br><span class="line">        name: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: harbor.od.com/infra/kibana:v5.6.16</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ELASTICSEARCH_URL</span><br><span class="line">          value: http://10.4.7.12:9200</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/kibana/svc.yaml</span><br><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 5601</span><br><span class="line">    targetPort: 5601</span><br><span class="line">    selector: </span><br><span class="line">    app: kibana</span><br><span class="line">    clusterIP: None</span><br><span class="line">    type: ClusterIP</span><br><span class="line">    sessionAffinity: None</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Ingress</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vi /data/k8s-yaml/kibana/ingress.yaml</span><br><span class="line"></span><br><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kibana</span><br><span class="line">          servicePort: 5601</span><br></pre></td></tr></tbody></table></figure>





<h3 id="应用资源配置清单-2"><a href="#应用资源配置清单-2" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><ul>
<li>任意运算节点上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f deployment.yaml </span><br><span class="line">deployment.extensions/kibana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f svc.yaml </span><br><span class="line">service/kibana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f ingress.yaml </span><br><span class="line">ingress.extensions/kibana created</span><br></pre></td></tr></tbody></table></figure>


<h3 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><ul>
<li><a target="_blank" rel="noopener" href="http://kibana.od.com/">http://kibana.od.com</a><br><img src="https://blog.stanley.wang/images/kibana.png" alt="kibana页面"></li>
</ul>
<h3 id="kibana的使用"><a href="#kibana的使用" class="headerlink" title="kibana的使用"></a>kibana的使用</h3><p><img src="https://blog.stanley.wang/images/kibana-usage.png" alt="kibana用法"></p>
<h3 id="选择区域"><a href="#选择区域" class="headerlink" title="选择区域"></a>选择区域</h3><ul>
<li><p>@timestamp</p>
<ul>
<li>对应日志的时间戳</li>
</ul>
</li>
<li><p>log.file.path</p>
<ul>
<li>对应日志文件名</li>
</ul>
</li>
<li><p>message</p>
<ul>
<li>对应日志内容</li>
</ul>
</li>
<li><p>时间选择器</p>
<ul>
<li>选择日志时间<ul>
<li>快速时间</li>
<li>绝对时间</li>
<li>相对时间</li>
</ul>
</li>
</ul>
</li>
<li><p>环境选择器</p>
<ul>
<li>选择对应环境的日志<ul>
<li>k8s-test-</li>
<li>k8s-prod-</li>
</ul>
</li>
</ul>
</li>
<li><p>项目选择器</p>
<ul>
<li>对应filebeat的PROJ_NAME值</li>
<li>Add a fillter</li>
<li>topic is ${PROJ_NAME}<ul>
<li>dubbo-demo-service</li>
<li>dubbo-demo-web</li>
</ul>
</li>
</ul>
</li>
<li><p>关键字选择器</p>
</li>
<li><p>exception</p>
</li>
<li><p>error</p>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Lustudio</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/12/21/ELK%E6%94%B6%E9%9B%86kubernetes%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97/">http://example.com/2020/12/21/ELK%E6%94%B6%E9%9B%86kubernetes%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Lustudio</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/21/Centos-%E6%90%AD%E5%BB%BAOpenVPN%E6%9C%8D%E5%8A%A1/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Centos-搭建OpenVPN服务</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/21/GitLab-Pipeline%E8%AF%AD%E6%B3%95-pipline-syntax-1/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">GitLab-Pipeline语法-pipline-syntax-1</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/12/21/交付服务到kubernetes集群/" title="交付服务到kubernetes集群"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-21</div><div class="title">交付服务到kubernetes集群</div></div></a></div><div><a href="/2020/12/21/二进制部署kubernetes集群/" title="二进制部署kubernetes集群"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-21</div><div class="title">二进制部署kubernetes集群</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E9%80%A0dubbo-demo-web%E9%A1%B9%E7%9B%AE%E4%B8%BATomcat%E5%90%AF%E5%8A%A8%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.</span> <span class="toc-text">改造dubbo-demo-web项目为Tomcat启动项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87Tomcat%E7%9A%84%E9%95%9C%E5%83%8F%E5%BA%95%E5%8C%85"><span class="toc-number">2.</span> <span class="toc-text">准备Tomcat的镜像底包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87tomcat%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85"><span class="toc-number">2.1.</span> <span class="toc-text">准备tomcat二进制包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AEtomcat"><span class="toc-number">2.2.</span> <span class="toc-text">简单配置tomcat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87Dockerfile"><span class="toc-number">2.3.</span> <span class="toc-text">准备Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%E5%B9%B6%E6%8E%A8%E9%80%81"><span class="toc-number">2.4.</span> <span class="toc-text">制作镜像并推送</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E9%80%A0dubbo-demo-web%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.</span> <span class="toc-text">改造dubbo-demo-web项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9dubbo-client-pom-xml"><span class="toc-number">3.1.</span> <span class="toc-text">修改dubbo-client&#x2F;pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9Application-java"><span class="toc-number">3.2.</span> <span class="toc-text">修改Application.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAServletInitializer-java"><span class="toc-number">3.3.</span> <span class="toc-text">创建ServletInitializer.java</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAJenkins%E7%9A%84pipeline"><span class="toc-number">3.4.</span> <span class="toc-text">新建Jenkins的pipeline</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline-Script"><span class="toc-number">3.5.</span> <span class="toc-text">Pipeline Script</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%BA%94%E7%94%A8%E9%95%9C%E5%83%8F"><span class="toc-number">3.6.</span> <span class="toc-text">构建应用镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87k8s%E7%9A%84%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">3.7.</span> <span class="toc-text">准备k8s的资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">3.8.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">3.9.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5tomcat%E8%BF%90%E8%A1%8C%E6%83%85%E5%86%B5"><span class="toc-number">3.10.</span> <span class="toc-text">检查tomcat运行情况</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#elk%E7%AE%80%E4%BB%8B"><span class="toc-number">4.</span> <span class="toc-text">elk简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">4.1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2ElasticSearch"><span class="toc-number">4.2.</span> <span class="toc-text">部署ElasticSearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">4.4.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jvm-options"><span class="toc-number">4.5.</span> <span class="toc-text">jvm.options</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7"><span class="toc-number">4.6.</span> <span class="toc-text">创建普通用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">4.7.</span> <span class="toc-text">文件描述符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0"><span class="toc-number">4.8.</span> <span class="toc-text">调整内核参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">4.9.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4ES%E6%97%A5%E5%BF%97%E6%A8%A1%E6%9D%BF"><span class="toc-number">4.10.</span> <span class="toc-text">调整ES日志模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kafka"><span class="toc-number">5.</span> <span class="toc-text">部署kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">5.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="toc-number">5.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-1"><span class="toc-number">5.3.</span> <span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kafka-manager"><span class="toc-number">6.</span> <span class="toc-text">部署kafka-manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A1%E3%80%81%E5%87%86%E5%A4%87Dockerfile"><span class="toc-number">6.1.</span> <span class="toc-text">方法一：1、准备Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9A2%E3%80%81%E5%88%B6%E4%BD%9Cdocker%E9%95%9C%E5%83%8F"><span class="toc-number">6.2.</span> <span class="toc-text">方法一：2、制作docker镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BDdocker%E9%95%9C%E5%83%8F"><span class="toc-number">6.3.</span> <span class="toc-text">方法二：直接下载docker镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">6.4.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-1"><span class="toc-number">6.5.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D"><span class="toc-number">6.6.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE-1"><span class="toc-number">6.7.</span> <span class="toc-text">浏览器访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2filebeat"><span class="toc-number">7.</span> <span class="toc-text">部署filebeat</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9Cdocker%E9%95%9C%E5%83%8F"><span class="toc-number">7.1.</span> <span class="toc-text">制作docker镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87Dockerfile-1"><span class="toc-number">7.2.</span> <span class="toc-text">准备Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F"><span class="toc-number">7.3.</span> <span class="toc-text">制作镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">7.4.</span> <span class="toc-text">修改资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8dubbo-demo-consumer%E7%9A%84Tomcat%E7%89%88%E9%95%9C%E5%83%8F"><span class="toc-number">7.5.</span> <span class="toc-text">使用dubbo-demo-consumer的Tomcat版镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AEhttp-km-od-com"><span class="toc-number">7.6.</span> <span class="toc-text">浏览器访问http:&#x2F;&#x2F;km.od.com</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%95%B0%E6%8D%AE"><span class="toc-number">7.7.</span> <span class="toc-text">验证数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2logstash"><span class="toc-number">8.</span> <span class="toc-text">部署logstash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E7%89%88%E6%9C%AC"><span class="toc-number">8.1.</span> <span class="toc-text">选版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87docker%E9%95%9C%E5%83%8F"><span class="toc-number">8.2.</span> <span class="toc-text">准备docker镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Dockerfile"><span class="toc-number">8.3.</span> <span class="toc-text">自定义Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8docker%E9%95%9C%E5%83%8F"><span class="toc-number">8.4.</span> <span class="toc-text">启动docker镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8logstash%E9%95%9C%E5%83%8F"><span class="toc-number">8.5.</span> <span class="toc-text">启动logstash镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81ElasticSearch%E9%87%8C%E7%9A%84%E7%B4%A2%E5%BC%95"><span class="toc-number">8.6.</span> <span class="toc-text">验证ElasticSearch里的索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Kibana"><span class="toc-number">9.</span> <span class="toc-text">部署Kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87docker%E9%95%9C%E5%83%8F-1"><span class="toc-number">9.1.</span> <span class="toc-text">准备docker镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D-1"><span class="toc-number">9.2.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-1"><span class="toc-number">9.3.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-2"><span class="toc-number">9.4.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AE%BF%E9%97%AE-2"><span class="toc-number">9.5.</span> <span class="toc-text">浏览器访问</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kibana%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">9.6.</span> <span class="toc-text">kibana的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E5%8C%BA%E5%9F%9F"><span class="toc-number">9.7.</span> <span class="toc-text">选择区域</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Lustudio</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>