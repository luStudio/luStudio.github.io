<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>二进制部署kubernetes集群 | Lustudio</title><meta name="keywords" content="k8s"><meta name="author" content="Lustudio"><meta name="copyright" content="Lustudio"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="实验环境    主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点 10.4.7.21   HDSS7-22.host.com k8s运算节点2 10.4.7.22   HDSS7-200.host.com k8s运维">
<meta property="og:type" content="article">
<meta property="og:title" content="二进制部署kubernetes集群">
<meta property="og:url" content="http://example.com/2020/12/21/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="Lustudio">
<meta property="og:description" content="实验环境    主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点 10.4.7.21   HDSS7-22.host.com k8s运算节点2 10.4.7.22   HDSS7-200.host.com k8s运维">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2020-12-21T02:00:46.000Z">
<meta property="article:modified_time" content="2021-08-12T05:52:00.349Z">
<meta property="article:author" content="Lustudio">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2020/12/21/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":300},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '二进制部署kubernetes集群',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-08-12 13:52:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQae-91xlO6GYrOzk-6P_ZgTFMVDGq7tliWjw&amp;usqp=CAU" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">68</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Lustudio</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">二进制部署kubernetes集群</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-21T02:00:46.000Z" title="发表于 2020-12-21 10:00:46">2020-12-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-08-12T05:52:00.349Z" title="更新于 2021-08-12 13:52:00">2021-08-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="二进制部署kubernetes集群"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><hr>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>k8s代理节点1</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>k8s代理节点2</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>k8s运算节点</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>k8s运算节点2</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-200.host.com</td>
<td>k8s运维节点(docker仓库)</td>
<td>10.4.7.200</td>
</tr>
</tbody></table>
<h1 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a>硬件环境</h1><h2 id="5台vm，每台至少2c2g"><a href="#5台vm，每台至少2c2g" class="headerlink" title="- 5台vm，每台至少2c2g"></a>- 5台vm，每台至少2c2g</h2><h2 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h2><ul>
<li> OS: CentOS Linux release 7.6.1810 (Core)</li>
</ul>
<ul>
<li>kubernetes: v1.13.2<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/releases">kubernetes官方下载地址</a>      </li>
</ul>
</li>
</ul>
<ul>
<li>etcd: v3.1.18<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases">etcd官方下载地址</a></li>
</ul>
</li>
</ul>
<ul>
<li>flannel: v0.10.0<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel/releases">flannel官方下载地址</a>      </li>
</ul>
</li>
</ul>
<ul>
<li>bind9: v9.9.4<ul>
<li><a target="_blank" rel="noopener" href="https://www.isc.org/downloads/#">bind9官方下载地址</a>        </li>
</ul>
</li>
</ul>
<ul>
<li>harbor: v1.8.3<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases">harbor官方下载地址</a></li>
</ul>
</li>
</ul>
<ul>
<li>证书签发工具CFSSL: R1.2<ul>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64">cfssl下载地址</a>        </li>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64">cfssljson下载地址</a>         </li>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64">cfssl-certinfo下载地址</a></li>
</ul>
</li>
</ul>
<p><img src="https://i.loli.net/2020/01/16/ClbAUXMEjGkZR71.png" alt="k8s基本概念.png"></p>
<ul>
<li>其他可能用到的软件，均使用操作系统自带的yum源和epel源进行安装</li>
</ul>
<h2 id="前置准备工作"><a href="#前置准备工作" class="headerlink" title="前置准备工作"></a>前置准备工作</h2><h3 id="DNS服务安装部署"><a href="#DNS服务安装部署" class="headerlink" title="DNS服务安装部署"></a>DNS服务安装部署</h3><ul>
<li>创建主机域 host.com</li>
<li>创建业务域 od.com</li>
<li>主辅同步(10.4.7.11主、10.4.7.12辅)</li>
<li>客户端配置指向自建DNS</li>
</ul>
<h3 id="准备签发证书环境"><a href="#准备签发证书环境" class="headerlink" title="准备签发证书环境"></a>准备签发证书环境</h3><ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<h3 id="安装CFSSL"><a href="#安装CFSSL" class="headerlink" title="安装CFSSL"></a>安装CFSSL</h3><ul>
<li>证书签发工具CFSSL: R1.2<ul>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64">cfssl下载地址</a>  </li>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64">cfssljson下载地址</a> </li>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64">cfssl-certinfo下载地址</a> </li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# chmod +x /usr/bin/cfssl*</span><br></pre></td></tr></tbody></table></figure>
<h3 id="创建生成CA证书的JSON配置文件"><a href="#创建生成CA证书的JSON配置文件" class="headerlink" title="创建生成CA证书的JSON配置文件"></a>创建生成CA证书的JSON配置文件</h3><hr>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs/ca-config.json</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    "signing": {</span><br><span class="line">        "default": {</span><br><span class="line">            "expiry": "175200h"</span><br><span class="line">        },</span><br><span class="line">        "profiles": {</span><br><span class="line">            "server": {</span><br><span class="line">                "expiry": "175200h",</span><br><span class="line">                "usages": [</span><br><span class="line">                    "signing",</span><br><span class="line">                    "key encipherment",</span><br><span class="line">                    "server auth"</span><br><span class="line">                ]</span><br><span class="line">            },</span><br><span class="line">            "client": {</span><br><span class="line">                "expiry": "175200h",</span><br><span class="line">                "usages": [</span><br><span class="line">                    "signing",</span><br><span class="line">                    "key encipherment",</span><br><span class="line">                    "client auth"</span><br><span class="line">                ]</span><br><span class="line">            },</span><br><span class="line">            "peer": {</span><br><span class="line">                "expiry": "175200h",</span><br><span class="line">                "usages": [</span><br><span class="line">                    "signing",</span><br><span class="line">                    "key encipherment",</span><br><span class="line">                    "server auth",</span><br><span class="line">                    "client auth"</span><br><span class="line">                ]</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="证书类型"><a href="#证书类型" class="headerlink" title="证书类型"></a>证书类型</h3><ul>
<li>client certificate：客户端使用，用于服务端认证客户端,例如etcdctl、etcdproxy、fleetctl、docker客户端</li>
<li>server certificate:服务端使用，客户端以此验证服务端身份,例如docker服务端、kube-apiserver</li>
<li>peer certificate: 双向证书，用于etcd集群成员间通信</li>
</ul>
<h3 id="创建生成CA证书签名请求（csr）的JSON配置文件"><a href="#创建生成CA证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成CA证书签名请求（csr）的JSON配置文件"></a>创建生成CA证书签名请求（csr）的JSON配置文件</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs/ca-csr.json</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    "CN": "kubernetes-ca",</span><br><span class="line">    "hosts": [</span><br><span class="line">    ],</span><br><span class="line">    "key": {</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    },</span><br><span class="line">    "names": [</span><br><span class="line">        {</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "od",</span><br><span class="line">            "OU": "ops"</span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    "ca": {</span><br><span class="line">        "expiry": "175200h"</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法</li>
<li>C: Country， 国家</li>
<li>ST: State，州，省</li>
<li>L: Locality，地区，城市</li>
<li>O: Organization Name，组织名称，公司名称</li>
<li>OU: Organization Unit Name，组织单位名称，公司部门</li>
</ul>
<h3 id="生成CA证书和私钥"><a href="#生成CA证书和私钥" class="headerlink" title="生成CA证书和私钥"></a>生成CA证书和私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca - </span><br><span class="line">2019/01/18 09:31:19 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generate received request</span><br><span class="line">2019/01/18 09:31:19 [INFO] received CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 09:31:19 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] signed certificate with serial number 345276964513449660162382535043012874724976422200</span><br></pre></td></tr></tbody></table></figure>


<h3 id="生成ca-pem、ca-csr、ca-key-pem-CA私钥-需妥善保管"><a href="#生成ca-pem、ca-csr、ca-key-pem-CA私钥-需妥善保管" class="headerlink" title="生成ca.pem、ca.csr、ca-key.pem(CA私钥,需妥善保管)"></a>生成ca.pem、ca.csr、ca-key.pem(CA私钥,需妥善保管)</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l</span><br><span class="line">-rw-r--r-- 1 root root  836 Jan 16 11:04 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  332 Jan 16 11:10 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 16 11:17 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1001 Jan 16 11:17 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 16 11:17 ca.pem</span><br></pre></td></tr></tbody></table></figure>



<h2 id="部署docker环境"><a href="#部署docker环境" class="headerlink" title="部署docker环境"></a>部署docker环境</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br></pre></td></tr></tbody></table></figure>


<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">  "graph": "/data/docker",</span><br><span class="line">  "storage-driver": "overlay2",</span><br><span class="line">  "insecure-registries": ["registry.access.redhat.com","quay.io","harbor.od.com"],</span><br><span class="line">  "registry-mirrors": ["https://q2gr04ke.mirror.aliyuncs.com"],</span><br><span class="line">  "bip": "172.7.21.1/24",</span><br><span class="line">  "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">  "live-restore": true</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>==注意：这里bip要根据宿主机ip变化==</p>
<h3 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="line"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"># Uncomment TasksMax if your systemd version supports it.</span><br><span class="line"># Only systemd 226 and above support this version.</span><br><span class="line">#TasksMax=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"># set delegate yes so that systemd does not reset the cgroups of docker containers</span><br><span class="line">Delegate=yes</span><br><span class="line"># kill only the docker process, not all processes in the cgroup</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></tbody></table></figure>


<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable docker.service</span><br><span class="line"># systemctl start docker.service</span><br></pre></td></tr></tbody></table></figure>

<h3 id="部署docker镜像私有仓库harbor"><a href="#部署docker镜像私有仓库harbor" class="headerlink" title="部署docker镜像私有仓库harbor"></a>部署docker镜像私有仓库harbor</h3><ul>
<li>HDSS7-200.host.com上：</li>
<li>下载软件二进制包并解压</li>
<li><a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases/download/v1.8.5/harbor-offline-installer-v1.8.5.tgz">harbor下载地址</a></li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/opt/harbor</span><br><span class="line">[root@hdss7-200 harbor]# tar xf harbor-offline-installer-v1.8.5.tgz -C /opt</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# ll</span><br><span class="line">total 583848</span><br><span class="line">-rw-r--r-- 1 root root 597857483 Jan 17 14:58 harbor-offline-installer-v1.8.5.tgz</span><br></pre></td></tr></tbody></table></figure>


<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/opt/harbor/harbor.yml</span><br><span class="line">hostname: harbor.od.com</span><br><span class="line">http:</span><br><span class="line">  port: 180</span><br><span class="line">data_volume: /data/harbor</span><br><span class="line">location: /data/harbor/logs</span><br><span class="line">mkdir -p /data/harbor/logs</span><br></pre></td></tr></tbody></table></figure>

<h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install docker-compose -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa docker-compose</span><br><span class="line">docker-compose-1.18.0-2.el7.noarch</span><br></pre></td></tr></tbody></table></figure>

<h2 id="安装harbor"><a href="#安装harbor" class="headerlink" title="安装harbor"></a>安装harbor</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/opt/harbor</span><br><span class="line">[root@hdss7-200 harbor]# ./install.sh</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查harbor启动情况"><a href="#检查harbor启动情况" class="headerlink" title="检查harbor启动情况"></a>检查harbor启动情况</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker-compose ps</span><br><span class="line">       Name                     Command               State                                 Ports                               </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-adminserver   /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-core          /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-db            /entrypoint.sh postgres          Up      5432/tcp                                                          </span><br><span class="line">harbor-jobservice    /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-log           /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp                                         </span><br><span class="line">harbor-portal        nginx -g daemon off;             Up      80/tcp                                                            </span><br><span class="line">nginx                nginx -g daemon off;             Up      0.0.0.0:1443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:180-&gt;80/tcp</span><br><span class="line">redis                docker-entrypoint.sh redis ...   Up      6379/tcp                                                          </span><br><span class="line">registry             /entrypoint.sh /etc/regist ...   Up      5000/tcp                                                          </span><br><span class="line">registryctl          /harbor/start.sh                 Up</span><br></pre></td></tr></tbody></table></figure>
<h3 id="配置harbor的dns内网解析"><a href="#配置harbor的dns内网解析" class="headerlink" title="配置harbor的dns内网解析"></a>配置harbor的dns内网解析</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/named/od.com.zone</span><br><span class="line">harbor	60 IN A 10.4.7.200</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# dig -t A harbor.od.com @10.4.7.11 +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></tbody></table></figure>

<h2 id="安装nginx并配置"><a href="#安装nginx并配置" class="headerlink" title="安装nginx并配置"></a>安装nginx并配置</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install nginx -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa nginx</span><br><span class="line">nginx-1.12.2-2.el7.x86_64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/etc/nginx/conf.d/harbor.od.com.conf</span><br><span class="line">server {</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / {</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">server {</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate "certs/harbor.od.com.pem";</span><br><span class="line">    ssl_certificate_key "certs/harbor.od.com-key.pem";</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / {</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>注意：需要自签ssl证书，自签过程</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(umask 077; openssl  genrsa -out harbor.od.com-key.pem)</span><br><span class="line">openssl req -new -key harbor.od.com-key.pem  -out harbor.od.com.csr -subj "/CN=harbor.od.com/ST=Beijing/L=beijing/O=od/OU=ops"</span><br><span class="line">openssl   x509  -req -in harbor.od.com.csr  -CA ca.pem  -CAkey ca-key.pem  -CAcreateserial -out harbor.od.com.pem -days 3650</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# nginx</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# netstat -luntp|grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      6590/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      6590/nginx: master</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>浏览器打开<a target="_blank" rel="noopener" href="http://harbor.od.com/">http://harbor.od.com</a></li>
<li>用户名：admin</li>
<li>密码： Harbor12345</li>
</ul>
<h2 id="部署Master节点服务"><a href="#部署Master节点服务" class="headerlink" title="部署Master节点服务"></a>部署Master节点服务</h2><h2 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h2><h3 id="Etcd集群规划"><a href="#Etcd集群规划" class="headerlink" title="Etcd集群规划"></a>Etcd集群规划</h3><hr>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-12.host.com</td>
<td>etcd lead</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>etcd follow</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>etcd follow</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<ul>
<li>注意：这里部署文档以HDSS7-12.host.com主机为例，另外两台主机安装部署方法类似==</li>
</ul>
<h3 id="创建生成证书签名请求（csr）的JSON配置文件"><a href="#创建生成证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h3><h3 id="运维主机HDSS7-200-host-com上："><a href="#运维主机HDSS7-200-host-com上：" class="headerlink" title="运维主机HDSS7-200.host.com上："></a>运维主机HDSS7-200.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs/etcd-peer-csr.json</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    "CN": "etcd-peer",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "10.4.7.11",</span><br><span class="line">        "10.4.7.12",</span><br><span class="line">        "10.4.7.21",</span><br><span class="line">        "10.4.7.22"</span><br><span class="line">    ],</span><br><span class="line">    "key": {</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    },</span><br><span class="line">    "names": [</span><br><span class="line">        {</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "od",</span><br><span class="line">            "OU": "ops"</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="生成etcd证书和私钥"><a href="#生成etcd证书和私钥" class="headerlink" title="生成etcd证书和私钥"></a>生成etcd证书和私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json | cfssljson -bare etcd-peer</span><br><span class="line">2019/01/18 09:35:09 [INFO] generate received request</span><br><span class="line">2019/01/18 09:35:09 [INFO] received CSR</span><br><span class="line">2019/01/18 09:35:09 [INFO] generating key: rsa-2048</span><br><span class="line"></span><br><span class="line">2019/01/18 09:35:09 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:35:10 [INFO] signed certificate with serial number 324191491384928915605254764031096067872154649010</span><br><span class="line">2019/01/18 09:35:10 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查生成的证书、私钥"><a href="#检查生成的证书、私钥" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs</span><br><span class="line">[root@hdss7-200 certs]# ls -l|grep etcd</span><br><span class="line">-rw-r--r-- 1 root root  387 Jan 18 12:32 etcd-peer-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 18 12:32 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1074 Jan 18 12:32 etcd-peer.csr</span><br><span class="line">-rw-r--r-- 1 root root 1432 Jan 18 12:32 etcd-peer.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建etcd用户"><a href="#创建etcd用户" class="headerlink" title="创建etcd用户"></a>创建etcd用户</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HDSS7-12.host.com上：</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# useradd -s /sbin/nologin -M etcd</span><br></pre></td></tr></tbody></table></figure>

<h3 id="下载软件，解压，做软连接"><a href="#下载软件，解压，做软连接" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases/download/v3.1.8/etcd-v3.1.8-linux-amd64.tar.gz">etcd下载地址</a></li>
</ul>
<h3 id="HDSS7-12-host-com上："><a href="#HDSS7-12-host-com上：" class="headerlink" title="HDSS7-12.host.com上："></a>HDSS7-12.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/opt/src</span><br><span class="line">[root@hdss7-12 src]# ls -l</span><br><span class="line">total 9604</span><br><span class="line">-rw-r--r-- 1 root root 9831476 Jan 18 10:45 etcd-v3.1.20-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-12 src]# tar xf etcd-v3.1.20--linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-12 src]# ln -s /opt/etcd-v3.1.20-linux-amd64 /opt/etcd</span><br><span class="line">[root@hdss7-12 src]# ls -l /opt</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root   root   24 Jan 18 14:21 etcd -&gt; etcd-v3.1.20-linux-amd64</span><br><span class="line">drwxr-xr-x 4 478493 89939 166 Jun 16  2018 etcd-v3.1.20-linux-amd64</span><br><span class="line">drwxr-xr-x 2 root   root   45 Jan 18 14:21 src</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建目录，拷贝证书、私钥"><a href="#创建目录，拷贝证书、私钥" class="headerlink" title="创建目录，拷贝证书、私钥"></a>创建目录，拷贝证书、私钥</h3><ul>
<li>HDSS7-12.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# mkdir -p /data/etcd /data/logs/etcd-server </span><br><span class="line">[root@hdss7-12 src]# chown -R etcd.etcd /data/etcd /data/logs/etcd-server/</span><br><span class="line">[root@hdss7-12 src]# mkdir -p /opt/etcd/certs</span><br></pre></td></tr></tbody></table></figure>

<h3 id="将运维主机上生成的ca-pem、etcd-peer-key-pem、etcd-peer-pem拷贝到-opt-etcd-certs目录中，注意私钥文件权限600"><a href="#将运维主机上生成的ca-pem、etcd-peer-key-pem、etcd-peer-pem拷贝到-opt-etcd-certs目录中，注意私钥文件权限600" class="headerlink" title="将运维主机上生成的ca.pem、etcd-peer-key.pem、etcd-peer.pem拷贝到/opt/etcd/certs目录中，注意私钥文件权限600"></a>将运维主机上生成的ca.pem、etcd-peer-key.pem、etcd-peer.pem拷贝到/opt/etcd/certs目录中，注意私钥文件权限600</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd/certs</span><br><span class="line">[root@hdss7-12 certs]# chmod 600 etcd-peer-key.pem</span><br><span class="line">[root@hdss7-12 certs]# chown -R etcd.etcd /opt/etcd/certs/</span><br><span class="line">[root@hdss7-12 certs]# ls -l</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1354 Jan 18 14:45 ca.pem</span><br><span class="line">-rw------- 1 etcd etcd 1679 Jan 18 17:00 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1444 Jan 18 17:02 etcd-peer.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建etcd服务启动脚本"><a href="#创建etcd服务启动脚本" class="headerlink" title="创建etcd服务启动脚本"></a>创建etcd服务启动脚本</h3><ul>
<li>HDSS7-12.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd/etcd-server-startup.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./etcd --name etcd-server-7-12 \</span><br><span class="line">       --data-dir /data/etcd/etcd-server \</span><br><span class="line">       --listen-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --listen-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --quota-backend-bytes 8000000000 \</span><br><span class="line">       --initial-advertise-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --advertise-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --initial-cluster  etcd-server-7-12=https://10.4.7.12:2380,etcd-server-7-21=https://10.4.7.21:2380,etcd-server-7-22=https://10.4.7.22:2380 \</span><br><span class="line">       --ca-file ./certs/ca.pem \</span><br><span class="line">       --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --client-cert-auth  \</span><br><span class="line">       --trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --peer-client-cert-auth \</span><br><span class="line">       --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --log-output stdout</span><br></pre></td></tr></tbody></table></figure>

<p>==注意：etcd集群各主机的启动脚本略有不同，部署其他节点时注意修改。==</p>
<h3 id="调整权限和目录"><a href="#调整权限和目录" class="headerlink" title="调整权限和目录"></a>调整权限和目录</h3><ul>
<li>HDSS7-12.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chmod +x /opt/etcd/etcd-server-startup.sh</span><br></pre></td></tr></tbody></table></figure>

<h3 id="安装supervisor软件"><a href="#安装supervisor软件" class="headerlink" title="安装supervisor软件"></a>安装supervisor软件</h3><ul>
<li>HDSS7-12.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# yum install supervisor -y</span><br><span class="line">[root@hdss7-12 certs]# systemctl start supervisord</span><br><span class="line">[root@hdss7-12 certs]# systemctl enable supervisord</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建etcd-server的启动配置"><a href="#创建etcd-server的启动配置" class="headerlink" title="创建etcd-server的启动配置"></a>创建etcd-server的启动配置</h3><ul>
<li>HDSS7-12.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/etc/supervisord.d/etcd-server.ini</span><br><span class="line">[program:etcd-server]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=etcd                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<p>==注意：etcd集群各主机启动配置略有不同，配置其他节点时注意修改。==</p>
<h3 id="启动etcd服务并检查"><a href="#启动etcd服务并检查" class="headerlink" title="启动etcd服务并检查"></a>启动etcd服务并检查</h3><ul>
<li>HDSS7-12.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# supervisorctl start all</span><br><span class="line">etcd-server-7-12: started</span><br><span class="line">[root@hdss7-12 certs]# supervisorctl status   </span><br><span class="line">etcd-server-7-12                 RUNNING   pid 6692, uptime 0:00:05</span><br></pre></td></tr></tbody></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的etcd服务-略"><a href="#安装部署启动检查所有集群规划主机上的etcd服务-略" class="headerlink" title="安装部署启动检查所有集群规划主机上的etcd服务    略"></a>安装部署启动检查所有集群规划主机上的etcd服务    略</h3><h2 id="3台均启动后，检查集群状态"><a href="#3台均启动后，检查集群状态" class="headerlink" title="3台均启动后，检查集群状态"></a>3台均启动后，检查集群状态</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl cluster-health </span><br><span class="line">member 988139385f78284 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member 5a0ef2a004fc4349 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member f4a0cb0a765574a8 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl member list</span><br><span class="line">988139385f78284: name=etcd-server-7-22 peerURLs=https://10.4.7.22:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.22:2379 isLeader=false</span><br><span class="line">5a0ef2a004fc4349: name=etcd-server-7-21 peerURLs=https://10.4.7.21:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.21:2379 isLeader=false</span><br><span class="line">f4a0cb0a765574a8: name=etcd-server-7-12 peerURLs=https://10.4.7.12:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.12:2379 isLeader=true</span><br></pre></td></tr></tbody></table></figure>

<h3 id="部署kube-apiserver集群"><a href="#部署kube-apiserver集群" class="headerlink" title="部署kube-apiserver集群"></a>部署kube-apiserver集群</h3><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-11.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.12</td>
</tr>
</tbody></table>
<p>==注意：这里10.4.7.11和10.4.7.12使用nginx做4层负载均衡器，用keepalived跑一个vip：10.4.7.10，代理两个kube-apiserver，实现高可用==</p>
<h3 id="这里部署文档以HDSS7-21-host-com主机为例，另外一台运算节点安装部署方法类似"><a href="#这里部署文档以HDSS7-21-host-com主机为例，另外一台运算节点安装部署方法类似" class="headerlink" title="这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似"></a>这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似</h3><h3 id="下载软件，解压，做软连接-1"><a href="#下载软件，解压，做软连接-1" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><ul>
<li><p>HDSS7-21.host.com上：</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dl.k8s.io/v1.13.5/kubernetes-server-linux-amd64.tar.gz">kubernetes下载地址</a></p>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/opt/src</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 src]# ls -l|grep kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 16:46 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# tar xf kubernetes-server-linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-21 src]# mv /opt/kubernetes /opt/kubernetes-v1.13.2-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s /opt/kubernetes-v1.13.2-linux-amd64 /opt/kubernetes</span><br><span class="line">[root@hdss7-21 src]# mkdir /opt/kubernetes/server/bin/{cert,conf}</span><br><span class="line">[root@hdss7-21 src]# ls -l /opt|grep kubernetes</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 18 10:49 kubernetes -&gt; kubernetes-v1.13.2-linux-amd64/</span><br><span class="line">drwxr-xr-x 4 root   root         50 Jan 17 17:40 kubernetes-v1.13.2-linux-amd64</span><br></pre></td></tr></tbody></table></figure>

<h3 id="签发client证书"><a href="#签发client证书" class="headerlink" title="签发client证书"></a>签发client证书</h3><ul>
<li>运维主机HDSS7-200.host.com上：</li>
<li>apiserver和etcd通讯使用的证书，在这个过程中etcd是server端apiserver是客户端<h3 id="创建生成证书签名请求（csr）的JSON配置文件-1"><a href="#创建生成证书签名请求（csr）的JSON配置文件-1" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h3></li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs/client-csr.json</span><br><span class="line">{</span><br><span class="line">    "CN": "k8s-node",</span><br><span class="line">    "hosts": [</span><br><span class="line">    ],</span><br><span class="line">    "key": {</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    },</span><br><span class="line">    "names": [</span><br><span class="line">        {</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "od",</span><br><span class="line">            "OU": "ops"</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="生成client证书和私钥"><a href="#生成client证书和私钥" class="headerlink" title="生成client证书和私钥"></a>生成client证书和私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json | cfssljson -bare client</span><br><span class="line">2019/01/18 14:02:50 [INFO] generate received request</span><br><span class="line">2019/01/18 14:02:50 [INFO] received CSR</span><br><span class="line">2019/01/18 14:02:50 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:02:51 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:02:51 [INFO] signed certificate with serial number 423108651040279300242366884100637974155370861448</span><br><span class="line">2019/01/18 14:02:51 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></tbody></table></figure>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>检查生成的证书、私钥</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep client</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 11:13 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root  989 Jan 21 11:13 client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1367 Jan 21 11:13 client.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="签发kube-apiserver证书"><a href="#签发kube-apiserver证书" class="headerlink" title="签发kube-apiserver证书"></a>签发kube-apiserver证书</h3><ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<h3 id="创建生成证书签名请求（csr）的JSON配置文件-2"><a href="#创建生成证书签名请求（csr）的JSON配置文件-2" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs/apiserver-csr.json</span><br><span class="line">{</span><br><span class="line">    "CN": "apiserver",</span><br><span class="line">    "hosts": [</span><br><span class="line">        "127.0.0.1",</span><br><span class="line">        "192.168.0.1",</span><br><span class="line">        "kubernetes.default",</span><br><span class="line">        "kubernetes.default.svc",</span><br><span class="line">        "kubernetes.default.svc.cluster",</span><br><span class="line">        "kubernetes.default.svc.cluster.local",</span><br><span class="line">        "10.4.7.10",</span><br><span class="line">        "10.4.7.21",</span><br><span class="line">        "10.4.7.22",</span><br><span class="line">        "10.4.7.23"</span><br><span class="line">    ],</span><br><span class="line">    "key": {</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    },</span><br><span class="line">    "names": [</span><br><span class="line">        {</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "od",</span><br><span class="line">            "OU": "ops"</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="生成kube-apiserver证书和私钥"><a href="#生成kube-apiserver证书和私钥" class="headerlink" title="生成kube-apiserver证书和私钥"></a>生成kube-apiserver证书和私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json | cfssljson -bare apiserver </span><br><span class="line">2019/01/18 14:05:44 [INFO] generate received request</span><br><span class="line">2019/01/18 14:05:44 [INFO] received CSR</span><br><span class="line">2019/01/18 14:05:44 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:05:46 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:05:46 [INFO] signed certificate with serial number 633406650960616624590510576685608580490218676227</span><br><span class="line">2019/01/18 14:05:46 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查生成的证书、私钥-1"><a href="#检查生成的证书、私钥-1" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep apiserver</span><br><span class="line">total 72</span><br><span class="line">-rw-r--r-- 1 root root  406 Jan 21 14:10 apiserver-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 14:11 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1082 Jan 21 14:11 apiserver.csr</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 14:11 apiserver.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置"><a href="#拷贝证书至各运算节点，并创建配置" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<h3 id="拷贝证书、私钥，注意私钥文件属性600"><a href="#拷贝证书、私钥，注意私钥文件属性600" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/cert</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 cert]# ls -l /opt/kubernetes/server/bin/cert</span><br><span class="line">total 40</span><br><span class="line">-rw------- 1 root root 1676 Jan 21 16:39 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 16:36 apiserver.pem</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 13:55 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 21 13:50 ca.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 13:53 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1368 Jan 21 13:53 client.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建配置"><a href="#创建配置" class="headerlink" title="创建配置"></a>创建配置</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/conf/audit.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: audit.k8s.io/v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don't generate audit events for all requests in RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - "RequestReceived"</span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: ""</span><br><span class="line">      # Resource "pods" doesn't match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: ["pods"]</span><br><span class="line">  # Log "pods/log", "pods/status" at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: ""</span><br><span class="line">      resources: ["pods/log", "pods/status"]</span><br><span class="line"></span><br><span class="line">  # Don't log requests to a configmap called "controller-leader"</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: ""</span><br><span class="line">      resources: ["configmaps"]</span><br><span class="line">      resourceNames: ["controller-leader"]</span><br><span class="line"></span><br><span class="line">  # Don't log watch requests by the "system:kube-proxy" on endpoints or services</span><br><span class="line">  - level: None</span><br><span class="line">    users: ["system:kube-proxy"]</span><br><span class="line">    verbs: ["watch"]</span><br><span class="line">    resources:</span><br><span class="line">    - group: "" # core API group</span><br><span class="line">      resources: ["endpoints", "services"]</span><br><span class="line"></span><br><span class="line">  # Don't log authenticated requests to certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: ["system:authenticated"]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - "/api*" # Wildcard matching.</span><br><span class="line">    - "/version"</span><br><span class="line"></span><br><span class="line">  # Log the request body of configmap changes in kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: "" # core API group</span><br><span class="line">      resources: ["configmaps"]</span><br><span class="line">    # This rule only applies to resources in the "kube-system" namespace.</span><br><span class="line">    # The empty string "" can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: ["kube-system"]</span><br><span class="line"></span><br><span class="line">  # Log configmap and secret changes in all other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: "" # core API group</span><br><span class="line">      resources: ["secrets", "configmaps"]</span><br><span class="line"></span><br><span class="line">  # Log all other resources in core and extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: "" # core API group</span><br><span class="line">    - group: "extensions" # Version of group should NOT be included.</span><br><span class="line"></span><br><span class="line">  # A catch-all rule to log all other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - "RequestReceived"</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/kube-apiserver.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">./kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \     #apiserver启动数量</span><br><span class="line">  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \</span><br><span class="line">  --audit-policy-file ./conf/audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --requestheader-client-ca-file ./cert/ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile ./cert/ca.pem \</span><br><span class="line">  --etcd-certfile ./cert/client.pem \</span><br><span class="line">  --etcd-keyfile ./cert/client-key.pem \</span><br><span class="line">  --etcd-servers https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb=1024 \</span><br><span class="line">  --kubelet-client-certificate ./cert/client.pem \</span><br><span class="line">  --kubelet-client-key ./cert/client-key.pem \</span><br><span class="line">  --log-dir  /data/logs/kubernetes/kube-apiserver \</span><br><span class="line">  --tls-cert-file ./cert/apiserver.pem \</span><br><span class="line">  --tls-private-key-file ./cert/apiserver-key.pem \</span><br><span class="line">  --v 2  #日志级别详细程度的数字</span><br></pre></td></tr></tbody></table></figure>

<h3 id="调整权限和目录-1"><a href="#调整权限和目录-1" class="headerlink" title="调整权限和目录"></a>调整权限和目录</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin</span><br><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-apiserver.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-apiserver</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建supervisor配置"><a href="#创建supervisor配置" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/etc/supervisord.d/kube-apiserver.ini</span><br><span class="line"></span><br><span class="line">[program:kube-apiserver]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动服务并检查"><a href="#启动服务并检查" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-apiserverr: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br></pre></td></tr></tbody></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-apiserver-略"><a href="#安装部署启动检查所有集群规划主机上的kube-apiserver-略" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-apiserver    略"></a>安装部署启动检查所有集群规划主机上的kube-apiserver    略</h3><h2 id="配4层反向代理"><a href="#配4层反向代理" class="headerlink" title="配4层反向代理"></a>配4层反向代理</h2><ul>
<li>HDSS7-11.host.com,  HDSS7-12.host.com上：</li>
</ul>
<h3 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/nginx.conf</span><br><span class="line"></span><br><span class="line">stream {</span><br><span class="line">    upstream kube-apiserver {</span><br><span class="line">        server 10.4.7.21:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">    }</span><br><span class="line">    server {</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="keepalived配置"><a href="#keepalived配置" class="headerlink" title="keepalived配置"></a>keepalived配置</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/etc/keepalived/check_port.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">#keepalived 监控端口脚本</span><br><span class="line">#使用方法：</span><br><span class="line">#在keepalived的配置文件中</span><br><span class="line"></span><br><span class="line">#vrrp_script check_port {#创建一个vrrp_script脚本,检查配置</span><br><span class="line">#    script "/etc/keepalived/check_port.sh 6379" #配置监听的端口</span><br><span class="line">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="line">#}</span><br><span class="line">CHK_PORT=$1</span><br><span class="line">if [ -n "$CHK_PORT" ];then</span><br><span class="line">        PORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo "Port $CHK_PORT Is Not Used,End."</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo "Check Port Cant Be Empty!"</span><br><span class="line">fi</span><br></pre></td></tr></tbody></table></figure>



<h2 id="keepalived主"><a href="#keepalived主" class="headerlink" title="keepalived主"></a>keepalived主</h2><h3 id="HDSS7-11-host-com上"><a href="#HDSS7-11-host-com上" class="headerlink" title="HDSS7-11.host.com上"></a>HDSS7-11.host.com上</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br><span class="line">/etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">   router_id 10.4.7.11</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx {</span><br><span class="line">    script "/etc/keepalived/check_port.sh 7443"</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    mcast_src_ip 10.4.7.11</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    }</span><br><span class="line">    track_script {</span><br><span class="line">         chk_nginx</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        10.4.7.10</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="keepalived备"><a href="#keepalived备" class="headerlink" title="keepalived备"></a>keepalived备</h3><h3 id="HDSS7-12-host-com上"><a href="#HDSS7-12-host-com上" class="headerlink" title="HDSS7-12.host.com上"></a>HDSS7-12.host.com上</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br><span class="line">/etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs {</span><br><span class="line">	router_id 10.4.7.12</span><br><span class="line">}</span><br><span class="line">vrrp_script chk_nginx {</span><br><span class="line">	script "/etc/keepalived/check_port.sh 7443"</span><br><span class="line">	interval 2</span><br><span class="line">	weight -20</span><br><span class="line">}</span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 251</span><br><span class="line">	mcast_src_ip 10.4.7.12</span><br><span class="line">	priority 90</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication {</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 11111111</span><br><span class="line">	}</span><br><span class="line">	track_script {</span><br><span class="line">		chk_nginx</span><br><span class="line">	}</span><br><span class="line">	virtual_ipaddress {</span><br><span class="line">		10.4.7.10</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动代理并检查"><a href="#启动代理并检查" class="headerlink" title="启动代理并检查"></a>启动代理并检查</h3><h3 id="HDSS7-11-host-com-HDSS7-12-host-com上："><a href="#HDSS7-11-host-com-HDSS7-12-host-com上：" class="headerlink" title="HDSS7-11.host.com,HDSS7-12.host.com上："></a>HDSS7-11.host.com,HDSS7-12.host.com上：</h3><h3 id="启动-2"><a href="#启动-2" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-11 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-11 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-12 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-12 ~]# nginx -s reload</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查-1"><a href="#检查-1" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-12 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br><span class="line">    inet 10.9.7.10/32 scope global vir0</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br></pre></td></tr></tbody></table></figure>


<h2 id="部署controller-manager"><a href="#部署controller-manager" class="headerlink" title="部署controller-manager"></a>部署controller-manager</h2><hr>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>controller-manager</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>controller-manager</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p>==注意：这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似==</p>
<h3 id="创建启动脚本-1"><a href="#创建启动脚本-1" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><h3 id="HDSS7-21-host-com上："><a href="#HDSS7-21-host-com上：" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/kube-controller-manager.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-controller-manager \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --root-ca-file ./cert/ca.pem \</span><br><span class="line">  --v 2</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="调整文件权限，创建目录"><a href="#调整文件权限，创建目录" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><p>HDSS7-21.host.com上：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin</span><br><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-controller-manager</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建supervisor配置-1"><a href="#创建supervisor配置-1" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><h3 id="HDSS7-21-host-com上：-1"><a href="#HDSS7-21-host-com上：-1" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/etc/supervisord.d/kube-conntroller-manager.ini</span><br><span class="line"></span><br><span class="line">[program:kube-controller-manager]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                                     ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                                       ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                                       ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动服务并检查-1"><a href="#启动服务并检查-1" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><h3 id="HDSS7-21-host-com上：-2"><a href="#HDSS7-21-host-com上：-2" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-controller-manager: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status   </span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager          RUNNING   pid 44230, uptime 2:05:01</span><br></pre></td></tr></tbody></table></figure>


<h2 id="部署kube-scheduler"><a href="#部署kube-scheduler" class="headerlink" title="部署kube-scheduler"></a>部署kube-scheduler</h2><h3 id="集群规划-1"><a href="#集群规划-1" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p>==注意：这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似==</p>
<h3 id="创建启动脚本-2"><a href="#创建启动脚本-2" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><h3 id="HDSS7-21-host-com上：-3"><a href="#HDSS7-21-host-com上：-3" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">./kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-scheduler \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br></pre></td></tr></tbody></table></figure>

<h3 id="调整文件权限，创建目录-1"><a href="#调整文件权限，创建目录-1" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><h3 id="HDSS7-21-host-com上：-4"><a href="#HDSS7-21-host-com上：-4" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin</span><br><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-scheduler</span><br></pre></td></tr></tbody></table></figure>


<h3 id="创建supervisor配置-2"><a href="#创建supervisor配置-2" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><h3 id="HDSS7-21-host-com上：-5"><a href="#HDSS7-21-host-com上：-5" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/etc/supervisord.d/kube-scheduler.ini</span><br><span class="line">[program:kube-scheduler]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                            ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                     ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                              ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                              ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动服务并检查-2"><a href="#启动服务并检查-2" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><h3 id="HDSS7-21-host-com上：-6"><a href="#HDSS7-21-host-com上：-6" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-scheduler: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager          RUNNING   pid 44230, uptime 2:05:01</span><br><span class="line">kube-scheduler                   RUNNING   pid 44779, uptime 2:02:27</span><br></pre></td></tr></tbody></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-scheduler服务-略"><a href="#安装部署启动检查所有集群规划主机上的kube-scheduler服务-略" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-scheduler服务   略"></a>安装部署启动检查所有集群规划主机上的kube-scheduler服务   略</h3><h1 id="部署Node节点服务"><a href="#部署Node节点服务" class="headerlink" title="部署Node节点服务"></a>部署Node节点服务</h1><h2 id="部署kubelet"><a href="#部署kubelet" class="headerlink" title="部署kubelet"></a>部署kubelet</h2><h3 id="集群规划-2"><a href="#集群规划-2" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kubelet</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kubelet</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p>==注意：这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似==</p>
<h3 id="签发kubelet证书"><a href="#签发kubelet证书" class="headerlink" title="签发kubelet证书"></a>签发kubelet证书</h3><h3 id="运维主机HDSS7-200-host-com上：-1"><a href="#运维主机HDSS7-200-host-com上：-1" class="headerlink" title="运维主机HDSS7-200.host.com上："></a>运维主机HDSS7-200.host.com上：</h3><h3 id="创建生成证书签名请求（csr）的JSON配置文件-3"><a href="#创建生成证书签名请求（csr）的JSON配置文件-3" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kubelet-csr.json</span><br><span class="line">{</span><br><span class="line">    "CN": "k8s-kubelet",</span><br><span class="line">    "hosts": [</span><br><span class="line">    "127.0.0.1",</span><br><span class="line">    "10.4.7.10",</span><br><span class="line">    "10.4.7.21",</span><br><span class="line">    "10.4.7.22",</span><br><span class="line">    "10.4.7.23",</span><br><span class="line">    "10.4.7.24",</span><br><span class="line">    "10.4.7.25",</span><br><span class="line">    "10.4.7.26",</span><br><span class="line">    "10.4.7.27",</span><br><span class="line">    "10.4.7.28"</span><br><span class="line">    ],</span><br><span class="line">    "key": {</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    },</span><br><span class="line">    "names": [</span><br><span class="line">        {</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "od",</span><br><span class="line">            "OU": "ops"</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="生成kubelet证书和私钥"><a href="#生成kubelet证书和私钥" class="headerlink" title="生成kubelet证书和私钥"></a>生成kubelet证书和私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs</span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssljson -bare kubelet</span><br><span class="line">2019/01/18 17:51:16 [INFO] generate received request</span><br><span class="line">2019/01/18 17:51:16 [INFO] received CSR</span><br><span class="line">2019/01/18 17:51:16 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 17:51:17 [INFO] encoded CSR</span><br><span class="line">2019/01/18 17:51:17 [INFO] signed certificate with serial number 48870268157415133698067712395152321546974943470</span><br><span class="line">2019/01/18 17:51:17 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查生成的证书、私钥-2"><a href="#检查生成的证书、私钥-2" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs</span><br><span class="line">[root@hdss7-200 certs]# ls -l|grep kubelet</span><br><span class="line">total 88</span><br><span class="line">-rw-r--r-- 1 root root  415 Jan 22 16:58 kubelet-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:00 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1086 Jan 22 17:00 kubelet.csr</span><br><span class="line">-rw-r--r-- 1 root root 1456 Jan 22 17:00 kubelet.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-1"><a href="#拷贝证书至各运算节点，并创建配置-1" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><h3 id="HDSS7-21-host-com上：-7"><a href="#HDSS7-21-host-com上：-7" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><h3 id="拷贝证书、私钥，注意私钥文件属性600-1"><a href="#拷贝证书、私钥，注意私钥文件属性600-1" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/cert</span><br><span class="line">[root@hdss7-21 cert]# ls -l /opt/kubernetes/server/bin/cert</span><br><span class="line">total 40</span><br><span class="line">-rw------- 1 root root 1676 Jan 21 16:39 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 16:36 apiserver.pem</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 13:55 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 21 13:50 ca.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 13:53 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1368 Jan 21 13:53 client.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:00 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1456 Jan 22 17:00 kubelet.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建配置-1"><a href="#创建配置-1" class="headerlink" title="创建配置"></a>创建配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<h3 id="给kubectl创建软连接"><a href="#给kubectl创建软连接" class="headerlink" title="给kubectl创建软连接"></a>给kubectl创建软连接</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin</span><br><span class="line">[root@hdss7-21 bin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span><br><span class="line">[root@hdss7-21 bin]# which kubectl</span><br><span class="line">/usr/bin/kubectl</span><br></pre></td></tr></tbody></table></figure>
<h3 id="set-cluster"><a href="#set-cluster" class="headerlink" title="set-cluster"></a>set-cluster</h3><p>==注意：在conf目录下==</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster "myk8s" set.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="set-credentials"><a href="#set-credentials" class="headerlink" title="set-credentials"></a>set-credentials</h3><p>==注意：在conf目录下==</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials k8s-node \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line">User "k8s-node" set.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="set-context"><a href="#set-context" class="headerlink" title="set-context"></a>set-context</h3><p>==注意：在conf目录下==</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=k8s-node \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Context "myk8s-context" created.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<h3 id="use-context"><a href="#use-context" class="headerlink" title="use-context"></a>use-context</h3><p>==注意：在conf目录下==</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context "myk8s-context".</span><br><span class="line">k8s-node.yaml</span><br></pre></td></tr></tbody></table></figure>


<h3 id="创建资源配置文件"><a href="#创建资源配置文件" class="headerlink" title="创建资源配置文件"></a>创建资源配置文件</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/conf/k8s-node.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></tbody></table></figure>


<h3 id="应用资源配置文件"><a href="#应用资源配置文件" class="headerlink" title="应用资源配置文件"></a>应用资源配置文件</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# kubectl create -f k8s-node.yaml</span><br><span class="line"></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/k8s-node created</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查-2"><a href="#检查-2" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node</span><br><span class="line">NAME           AGE</span><br><span class="line">k8s-node       3m</span><br></pre></td></tr></tbody></table></figure>

<h3 id="kubectl命令自动补全"><a href="#kubectl命令自动补全" class="headerlink" title="kubectl命令自动补全"></a>kubectl命令自动补全</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# yum install bash-completion -y</span><br><span class="line">[root@hdss7-21 conf]# kubectl completion bash &gt;/etc/bash_completion.d/kubectl</span><br></pre></td></tr></tbody></table></figure>




<h3 id="准备pause基础镜像"><a href="#准备pause基础镜像" class="headerlink" title="准备pause基础镜像"></a>准备pause基础镜像</h3><ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull kubernetes/pause</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from kubernetes/pause</span><br><span class="line">4f4fb700ef54: Pull complete </span><br><span class="line">b9c8ec465f6b: Pull complete </span><br><span class="line">Digest: sha256:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105</span><br><span class="line">Status: Downloaded newer image for kubernetes/pause:latest</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="提交至私有仓库（harbor）中"><a href="#提交至私有仓库（harbor）中" class="headerlink" title="提交至私有仓库（harbor）中"></a>提交至私有仓库（harbor）中</h3><h3 id="配置主机登录私有仓库"><a href="#配置主机登录私有仓库" class="headerlink" title="配置主机登录私有仓库"></a>配置主机登录私有仓库</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/root/.docker/config.json</span><br><span class="line">{</span><br><span class="line">	"auths": {</span><br><span class="line">		"harbor.od.com": {</span><br><span class="line">			"auth": "YWRtaW46SGFyYm9yMTIzNDU="</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="这里代表：用户名admin，密码Harbor12345"><a href="#这里代表：用户名admin，密码Harbor12345" class="headerlink" title="这里代表：用户名admin，密码Harbor12345"></a>这里代表：用户名admin，密码Harbor12345</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# echo YWRtaW46SGFyYm9yMTIzNDU=|base64 -d</span><br><span class="line">admin:Harbor12345</span><br></pre></td></tr></tbody></table></figure>


<p>==注意：也可以在各运算节点使用docker login harbor.od.com，输入用户名，密码==</p>
<h3 id="给镜像打tag"><a href="#给镜像打tag" class="headerlink" title="给镜像打tag"></a>给镜像打tag</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker images |grep pause</span><br><span class="line">kubernetes/pause                latest                     f9d5de079539        5 years ago         240kB</span><br><span class="line">[root@hdss7-200 ~]# docker tag f9d5de079539   harbor.od.com/public/pause:latest</span><br><span class="line">[root@hdss7-200 ~]# </span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/pause:latest </span><br><span class="line">The push refers to a repository [harbor.od.com/public/pause]</span><br><span class="line">5f70bf18a086: Pushed </span><br><span class="line">e16a89738269: Pushed </span><br><span class="line">latest: digest: sha256:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105 size: 938</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建kubelet启动脚本"><a href="#创建kubelet启动脚本" class="headerlink" title="创建kubelet启动脚本"></a>创建kubelet启动脚本</h3><h3 id="HDSS7-21-host-com上：-8"><a href="#HDSS7-21-host-com上：-8" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/kubelet.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./kubelet \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \</span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups=/systemd/system.slice \</span><br><span class="line">  --kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">  --fail-swap-on="false" \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --tls-cert-file ./cert/kubelet.pem \</span><br><span class="line">  --tls-private-key-file ./cert/kubelet-key.pem \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --image-gc-high-threshold 20 \</span><br><span class="line">  --image-gc-low-threshold 10 \</span><br><span class="line">  --kubeconfig ./conf/kubelet.kubeconfig \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.od.com/public/pause:latest \</span><br><span class="line">  --root-dir /data/kubelet</span><br></pre></td></tr></tbody></table></figure>

<p>==注意：kubelet集群各主机的启动脚本略有不同，部署其他节点时注意修改。==</p>
<h3 id="检查配置，权限，创建日志目录"><a href="#检查配置，权限，创建日志目录" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><h3 id="HDSS7-21-host-com上：-9"><a href="#HDSS7-21-host-com上：-9" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line">[root@hdss7-21 conf]# ls -l|grep kubelet.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kubelet-721.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-kubelet</span><br><span class="line"> /data/kubelet</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建supervisor配置-3"><a href="#创建supervisor配置-3" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/etc/supervisord.d/kube-kubelet.ini</span><br><span class="line">[program:kube-kubelet]</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true              		          ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                     ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                       ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                       ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动服务并检查-3"><a href="#启动服务并检查-3" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><h3 id="HDSS7-21-host-com上：-10"><a href="#HDSS7-21-host-com上：-10" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-kubelet: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager          RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet                     STARTING  </span><br><span class="line">kube-scheduler                   RUNNING   pid 10041, uptime 18:22:13</span><br><span class="line">[root@ecs0-45 ~]# kubectl  label   node  ecs0-45.host.com   node-role.kubernetes.io/master=</span><br><span class="line">node/ecs0-45.host.com labeled</span><br><span class="line">[root@ecs0-45 ~]# kubectl  get nodes  -o wide </span><br><span class="line">NAME               STATUS   ROLES    AGE    VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME</span><br><span class="line">ecs0-45.host.com   Ready    master   10m    v1.15.4   192.168.0.45   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.3.el7.x86_64   docker://19.3.8</span><br><span class="line">ecs0-46.host.com   Ready    master   6d5h   v1.15.4   192.168.0.46   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-957.21.3.el7.x86_64   docker://19.3.8</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查运算节点"><a href="#检查运算节点" class="headerlink" title="检查运算节点"></a>检查运算节点</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES    AGE   VERSION</span><br><span class="line">hdss7-21.host.com   Ready    &lt;none&gt;   53s   v1.15.2</span><br><span class="line">hdss7-22.host.com   Ready    &lt;none&gt;   59s   v1.15.2</span><br><span class="line"></span><br><span class="line"># kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=</span><br><span class="line">kubectl get nodes</span><br><span class="line">NAME                STATUS   ROLES         AGE     VERSION</span><br><span class="line">hdss7-21.host.com   Ready    master,node   2m35s   v1.15.2</span><br><span class="line">hdss7-22.host.com   Ready    master,node   2m41s   v1.15.2</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<h2 id="部署kube-proxy"><a href="#部署kube-proxy" class="headerlink" title="部署kube-proxy"></a>部署kube-proxy</h2><h3 id="集群规划-3"><a href="#集群规划-3" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p>==注意：这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似==</p>
<h3 id="运维主机HDSS7-200-host-com上：-2"><a href="#运维主机HDSS7-200-host-com上：-2" class="headerlink" title="运维主机HDSS7-200.host.com上："></a>运维主机HDSS7-200.host.com上：</h3><h3 id="创建生成证书签名请求（csr）的JSON配置文件-4"><a href="#创建生成证书签名请求（csr）的JSON配置文件-4" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs/kube-proxy-csr.json</span><br><span class="line">{</span><br><span class="line">    "CN": "system:kube-proxy",</span><br><span class="line">    "key": {</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    },</span><br><span class="line">    "names": [</span><br><span class="line">        {</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "od",</span><br><span class="line">            "OU": "ops"</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="生成kube-proxy证书和私钥"><a href="#生成kube-proxy证书和私钥" class="headerlink" title="生成kube-proxy证书和私钥"></a>生成kube-proxy证书和私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs</span><br><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json | cfssljson -bare kube-proxy-client</span><br><span class="line">2019/01/18 18:14:23 [INFO] generate received request</span><br><span class="line">2019/01/18 18:14:23 [INFO] received CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 18:14:23 [INFO] encoded CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] signed certificate with serial number 375797145588654714099258750873820528127028390681</span><br><span class="line">2019/01/18 18:14:23 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 ("Information Requirements").</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查生成的证书、私钥-3"><a href="#检查生成的证书、私钥-3" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 certs]# ls -l|grep kube-proxy</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:31 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1005 Jan 22 17:31 kube-proxy-client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1383 Jan 22 17:31 kube-proxy-client.pem</span><br><span class="line">-rw-r--r-- 1 root root  268 Jan 22 17:23 kube-proxy-csr.json</span><br></pre></td></tr></tbody></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-2"><a href="#拷贝证书至各运算节点，并创建配置-2" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<h3 id="拷贝证书、私钥，注意私钥文件属性600-2"><a href="#拷贝证书、私钥，注意私钥文件属性600-2" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/cert</span><br><span class="line">[root@hdss7-21 cert]# ls -l /opt/kubernetes/server/bin/cert</span><br><span class="line">total 40</span><br><span class="line">-rw------- 1 root root 1676 Jan 21 16:39 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 16:36 apiserver.pem</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 13:55 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 21 13:50 ca.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 13:53 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1368 Jan 21 13:53 client.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:00 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1456 Jan 22 17:00 kubelet.pem</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:31 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1383 Jan 22 17:31 kube-proxy-client.pem</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建配置-2"><a href="#创建配置-2" class="headerlink" title="创建配置"></a>创建配置</h3><h3 id="set-cluster-1"><a href="#set-cluster-1" class="headerlink" title="set-cluster"></a>set-cluster</h3><h3 id="注意：在conf目录下"><a href="#注意：在conf目录下" class="headerlink" title="注意：在conf目录下"></a>注意：在conf目录下</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">opt/kubernetes/server/bin/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster "myk8s" set.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h4 id="set-credentials-1"><a href="#set-credentials-1" class="headerlink" title="set-credentials"></a>set-credentials</h4><p>==注意：在conf目录下==</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">User "kube-proxy" set.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="set-context-1"><a href="#set-context-1" class="headerlink" title="set-context"></a>set-context</h3><p>==注意：在conf目录下==</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">Context "myk8s-context" created.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="use-context-1"><a href="#use-context-1" class="headerlink" title="use-context"></a>use-context</h3><h3 id="注意：在conf目录下-1"><a href="#注意：在conf目录下-1" class="headerlink" title="注意：在conf目录下"></a>注意：在conf目录下</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/conf</span><br><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context "myk8s-context".</span><br></pre></td></tr></tbody></table></figure>
<h3 id="加载ipvs模块"><a href="#加载ipvs模块" class="headerlink" title="加载ipvs模块"></a>加载ipvs模块</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]#vim /root/ipvs.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">ipvs_mods_dir="/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs"</span><br><span class="line">for i in $(ls $ipvs_mods_dir|grep -o "^[^.]*")</span><br><span class="line">do</span><br><span class="line">  /sbin/modinfo -F filename $i &amp;&gt;/dev/null</span><br><span class="line">  if [ $? -eq 0 ];then</span><br><span class="line">    /sbin/modprobe $i</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></tbody></table></figure>


<h3 id="查看ipvs状态"><a href="#查看ipvs状态" class="headerlink" title="查看ipvs状态"></a>查看ipvs状态</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# lsmod |grep ip</span><br><span class="line">ip_vs_wlc              12519  0 </span><br><span class="line">ip_vs_sed              12519  0 </span><br><span class="line">ip_vs_pe_sip           12740  0 </span><br><span class="line">nf_conntrack_sip       33860  1 ip_vs_pe_sip</span><br><span class="line">ip_vs_nq               12516  0 </span><br><span class="line">ip_vs_lc               12516  0 </span><br><span class="line">ip_vs_lblcr            12922  0 </span><br><span class="line">ip_vs_lblc             12819  0 </span><br><span class="line">ip_vs_ftp              13079  0 </span><br><span class="line">ip_vs_dh               12688  0 </span><br><span class="line">ip_vs_sh               12688  0 </span><br><span class="line">ip_vs_wrr              12697  0 </span><br><span class="line">ip_vs_rr               12600  0 </span><br><span class="line">ip_vs                 145497  24 ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_pe_sip,ip_vs_lblcr,ip_vs_lblc</span><br><span class="line">ipt_MASQUERADE         12678  2 </span><br><span class="line">nf_nat_masquerade_ipv4    13412  1 ipt_MASQUERADE</span><br><span class="line">iptable_nat            12875  1 </span><br><span class="line">nf_conntrack_ipv4      15053  9 </span><br><span class="line">nf_defrag_ipv4         12729  1 nf_conntrack_ipv4</span><br><span class="line">nf_nat_ipv4            14115  1 iptable_nat</span><br><span class="line">iptable_filter         12810  1 </span><br><span class="line">nf_nat                 26787  4 ip_vs_ftp,nf_nat_ipv4,xt_nat,nf_nat_masquerade_ipv4</span><br><span class="line">nf_conntrack          133095  8 ip_vs,nf_nat,nf_nat_ipv4,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_sip,nf_conntrack_ipv4</span><br><span class="line">ip_tables              27126  2 iptable_filter,iptable_nat</span><br><span class="line">libcrc32c              12644  4 xfs,ip_vs,nf_nat,nf_conntrack</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<h3 id="创建kube-proxy启动脚本"><a href="#创建kube-proxy启动脚本" class="headerlink" title="创建kube-proxy启动脚本"></a>创建kube-proxy启动脚本</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-scheduler=nq \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br></pre></td></tr></tbody></table></figure>

<p>==注意：kube-proxy集群各主机的启动脚本略有不同，部署其他节点时注意修改。==</p>
<h3 id="检查配置，权限，创建日志目录-1"><a href="#检查配置，权限，创建日志目录-1" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/opt/kubernetes/server/conf</span><br><span class="line">[root@hdss7-21 conf]# ls -l|grep kube-proxy.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kube-proxy-721.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-proxy</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建supervisor配置-4"><a href="#创建supervisor配置-4" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/etc/supervisord.d/kube-proxy.ini</span><br><span class="line">[program:kube-proxy]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                        ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                            ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                 ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                         ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                             ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                          ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                          ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动服务并检查-4"><a href="#启动服务并检查-4" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-proxy: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager          RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet                     RUNNING   pid 14597, uptime 0:32:59</span><br><span class="line">kube-proxy                       STARTING  </span><br><span class="line">kube-scheduler                   RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></tbody></table></figure>


<h3 id="ipvs"><a href="#ipvs" class="headerlink" title="ipvs"></a>ipvs</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# yum install ipvsadm -y</span><br><span class="line">[root@hdss7-21 bin]# ipvsadm -Ln</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  192.168.0.1:443 nq</span><br><span class="line">  -&gt; 10.4.7.21:6443               Masq    1      0          0         </span><br><span class="line">  -&gt; 10.4.7.22:6443               Masq    1      0          0  </span><br></pre></td></tr></tbody></table></figure>


<h3 id="安装部署启动检查所有集群规划主机上的kube-proxy服务-略"><a href="#安装部署启动检查所有集群规划主机上的kube-proxy服务-略" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-proxy服务   略"></a>安装部署启动检查所有集群规划主机上的kube-proxy服务   略</h3><h1 id="部署addons插件"><a href="#部署addons插件" class="headerlink" title="部署addons插件"></a>部署addons插件</h1><h2 id="验证kubernetes集群"><a href="#验证kubernetes集群" class="headerlink" title="验证kubernetes集群"></a>验证kubernetes集群</h2><h3 id="在任意一个运算节点，创建一个资源配置清单这里我们选择HDSS7-21-host-com主机"><a href="#在任意一个运算节点，创建一个资源配置清单这里我们选择HDSS7-21-host-com主机" class="headerlink" title="在任意一个运算节点，创建一个资源配置清单这里我们选择HDSS7-21.host.com主机"></a>在任意一个运算节点，创建一个资源配置清单这里我们选择HDSS7-21.host.com主机</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/root/nginx-ds.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></tbody></table></figure>

<h3 id="应用资源配置，并检查"><a href="#应用资源配置，并检查" class="headerlink" title="应用资源配置，并检查"></a>应用资源配置，并检查</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/root</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl create -f nginx-ds.yaml</span><br><span class="line">[root@hdss7-21 ~]# kubectl get pods</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-6hnc7   1/1     Running   0          99m</span><br><span class="line">nginx-ds-m5q6j   1/1     Running   0          18h</span><br></pre></td></tr></tbody></table></figure>

<h2 id="部署flannel"><a href="#部署flannel" class="headerlink" title="部署flannel"></a>部署flannel</h2><h3 id="集群规划-4"><a href="#集群规划-4" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>flannel</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>flannel</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p>==注意：这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似==</p>
<h3 id="在各运算节点上增加iptables规则"><a href="#在各运算节点上增加iptables规则" class="headerlink" title="在各运算节点上增加iptables规则"></a>在各运算节点上增加iptables规则</h3><p>==注意：iptables规则各主机的略有不同，其他运算节点上执行时注意修改。==</p>
<h3 id="优化SNAT规则，各运算节点之间的各POD之间的网络通信不再出网"><a href="#优化SNAT规则，各运算节点之间的各POD之间的网络通信不再出网" class="headerlink" title="优化SNAT规则，各运算节点之间的各POD之间的网络通信不再出网"></a>优化SNAT规则，各运算节点之间的各POD之间的网络通信不再出网</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]# yum install iptables-services -y</span><br><span class="line">~]# iptables -t nat -D POSTROUTING -s 172.7.21.0/24 ! -o docker0 -j MASQUERADE</span><br><span class="line">~]# iptables -t nat -I POSTROUTING -s 172.7.21.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE</span><br><span class="line">~]# iptables-save |grep -i postrouting</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-4-7-21主机上的，来源是172-7-21-0-24段的docker的ip，目标ip不是172-7-0-0-16段，网络发包不从docker0桥设备出站的，才进行SNAT转换"><a href="#10-4-7-21主机上的，来源是172-7-21-0-24段的docker的ip，目标ip不是172-7-0-0-16段，网络发包不从docker0桥设备出站的，才进行SNAT转换" class="headerlink" title="10.4.7.21主机上的，来源是172.7.21.0/24段的docker的ip，目标ip不是172.7.0.0/16段，网络发包不从docker0桥设备出站的，才进行SNAT转换"></a>10.4.7.21主机上的，来源是172.7.21.0/24段的docker的ip，目标ip不是172.7.0.0/16段，网络发包不从docker0桥设备出站的，才进行SNAT转换</h3><h3 id="各运算节点保存iptables规则"><a href="#各运算节点保存iptables规则" class="headerlink" title="各运算节点保存iptables规则"></a>各运算节点保存iptables规则</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></tbody></table></figure>

<h3 id="下载软件，解压，做软连接-2"><a href="#下载软件，解压，做软连接-2" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/opt/src</span><br><span class="line">[root@hdss7-21 src]# wget https://github.com/coreos/flannel/releases/download/v0.11.0/flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# ls -l|grep flannel</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 18:46 flannel-v0.11.0-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# mkdir -p /opt/flannel-v0.11.0-linux-amd64/cert</span><br><span class="line">[root@hdss7-21 src]# tar xf flannel-v0.11.0-linux-amd64.tar.gz -C /opt/flannel-v0.11.0-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s /opt/flannel-v0.11.0-linux-amd64 /opt/flannel</span><br><span class="line">[root@hdss7-21 src]# ls -l /opt|grep flannel</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 17 18:49 flannel -&gt; flannel-v0.11.0-linux-amd64/</span><br><span class="line">drwxr-xr-x 4 root   root   50 Jan 17 18:47 flannel-v0.11.0-linux-amd64</span><br></pre></td></tr></tbody></table></figure>


<h3 id="拷贝证书到fanneld目录下cert"><a href="#拷贝证书到fanneld目录下cert" class="headerlink" title="拷贝证书到fanneld目录下cert"></a>拷贝证书到fanneld目录下cert</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# scp client-key.pem  client.pem   ca.pem   10.4.7.21:/opt/flannel/cert</span><br></pre></td></tr></tbody></table></figure>


<h3 id="最终目录结构"><a href="#最终目录结构" class="headerlink" title="最终目录结构"></a>最终目录结构</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/opt</span><br><span class="line">[root@hdss7-21 opt]# tree -L 2</span><br><span class="line">.</span><br><span class="line">|-- etcd -&gt; etcd-v3.1.18-linux-amd64</span><br><span class="line">|-- etcd-v3.1.18-linux-amd64</span><br><span class="line">|   |-- Documentation</span><br><span class="line">|   |-- README-etcdctl.md</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- READMEv2-etcdctl.md</span><br><span class="line">|   |-- certs</span><br><span class="line">|   |-- etcd</span><br><span class="line">|   |-- etcd-server-startup.sh</span><br><span class="line">|   `-- etcdctl</span><br><span class="line">|-- flannel -&gt; flannel-v0.10.0/</span><br><span class="line">|-- flannel-v0.10.0</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- cert</span><br><span class="line">|   |-- flanneld</span><br><span class="line">|   `-- mk-docker-opts.sh</span><br><span class="line">|-- kubernetes -&gt; kubernetes-v1.13.2-linux-amd64/</span><br><span class="line">|-- kubernetes-v1.13.2-linux-amd64</span><br><span class="line">|   |-- LICENSES</span><br><span class="line">|   |-- addons</span><br><span class="line">|   `-- server</span><br><span class="line">`-- src</span><br><span class="line">    |-- etcd-v3.1.18-linux-amd64.tar.gz</span><br><span class="line">    |-- flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">    `-- kubernetes-server-linux-amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>

<h3 id="操作etcd，增加host-gw"><a href="#操作etcd，增加host-gw" class="headerlink" title="操作etcd，增加host-gw"></a>操作etcd，增加host-gw</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/etcd</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 etcd]# ./etcdctl set /coreos.com/network/config '{"Network": "172.7.0.0/16", "Backend": {"Type": "host-gw"}}'</span><br><span class="line"></span><br><span class="line">{"Network": "172.7.0.0/16", "Backend": {"Type": "host-gw"}}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建配置-3"><a href="#创建配置-3" class="headerlink" title="创建配置"></a>创建配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/opt/flannel/subnet.env</span><br><span class="line">FLANNEL_NETWORK=172.7.0.0/16</span><br><span class="line">FLANNEL_SUBNET=172.7.21.1/24</span><br><span class="line">FLANNEL_MTU=1500</span><br><span class="line">FLANNEL_IPMASQ=false</span><br></pre></td></tr></tbody></table></figure>

<p>==注意：flannel集群各主机的配置略有不同，部署其他节点时注意修改。==</p>
<h3 id="创建启动脚本-3"><a href="#创建启动脚本-3" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><h3 id="HDSS7-21-host-com上：-11"><a href="#HDSS7-21-host-com上：-11" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/opt/flannel/flanneld.sh</span><br><span class="line">#!/bin/sh</span><br><span class="line">./flanneld \</span><br><span class="line">  --public-ip=10.4.7.21 \</span><br><span class="line">  --etcd-endpoints=https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --etcd-keyfile=./cert/client-key.pem \</span><br><span class="line">  --etcd-certfile=./cert/client.pem \</span><br><span class="line">  --etcd-cafile=./cert/ca.pem \</span><br><span class="line">  --iface=eth0 \</span><br><span class="line">  --subnet-file=./subnet.env \</span><br><span class="line">  --healthz-port=2401</span><br></pre></td></tr></tbody></table></figure>


<h3 id="注意：flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改。"><a href="#注意：flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改。" class="headerlink" title="注意：flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改。"></a>注意：flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改。</h3><h3 id="检查配置，权限，创建日志目录-2"><a href="#检查配置，权限，创建日志目录-2" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><h3 id="HDSS7-21-host-com上：-12"><a href="#HDSS7-21-host-com上：-12" class="headerlink" title="HDSS7-21.host.com上："></a>HDSS7-21.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/flannel</span><br><span class="line">[root@hdss7-21 flannel]# chmod +x /opt/flannel/flanneld.sh </span><br><span class="line"></span><br><span class="line">[root@hdss7-21 flannel]# mkdir -p /data/logs/flanneld</span><br></pre></td></tr></tbody></table></figure>

<h3 id="创建supervisor配置-5"><a href="#创建supervisor配置-5" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/etc/supervisord.d/flanneld.ini</span><br><span class="line">[program:flanneld-7-21]</span><br><span class="line">command=/opt/flannel/flanneld.sh                             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                   ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/flannel                                       ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                               ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                             ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                 ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                               ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                ; 'expected' exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                              ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                              ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                    ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                         ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/flanneld/flanneld.stdout.log       ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                     ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                  ; number of bytes in 'capturemode' (default 0)</span><br><span class="line">stdout_events_enabled=false                                  ; emit events on stdout writes (default false)</span><br><span class="line">killasgroup=true</span><br><span class="line">stopasgroup=true</span><br></pre></td></tr></tbody></table></figure>

<h3 id="启动服务并检查-5"><a href="#启动服务并检查-5" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><ul>
<li>HDSS7-21.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 flanneld]# supervisorctl update</span><br><span class="line">flanneld: added process group</span><br><span class="line">[root@hdss7-21 flanneld]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 1 day, 20:35:42</span><br><span class="line">flanneld                         STARTING  </span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 1 day, 19:01:43</span><br><span class="line">kube-controller-manager          RUNNING   pid 37646, uptime 0:58:48</span><br><span class="line">kube-kubelet                     RUNNING   pid 32640, uptime 17:16:36</span><br><span class="line">kube-proxy                       RUNNING   pid 15097, uptime 17:55:36</span><br><span class="line">kube-scheduler                   RUNNING   pid 37803, uptime 0:55:47</span><br></pre></td></tr></tbody></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的flannel服务略"><a href="#安装部署启动检查所有集群规划主机上的flannel服务略" class="headerlink" title="安装部署启动检查所有集群规划主机上的flannel服务略"></a>安装部署启动检查所有集群规划主机上的flannel服务略</h3><h3 id="部署k8s资源配置清单的内网http服务"><a href="#部署k8s资源配置清单的内网http服务" class="headerlink" title="部署k8s资源配置清单的内网http服务"></a>部署k8s资源配置清单的内网http服务</h3><ul>
<li>在运维主机HDSS7-200.host.com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/conf.d/k8s-yaml.od.com.conf</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  k8s-yaml.od.com;</span><br><span class="line"></span><br><span class="line">    location / {</span><br><span class="line">        autoindex on;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        root /data/k8s-yaml;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="配置内网DNS解析"><a href="#配置内网DNS解析" class="headerlink" title="配置内网DNS解析"></a>配置内网DNS解析</h3><h3 id="HDSS7-11-host-com上-1"><a href="#HDSS7-11-host-com上-1" class="headerlink" title="HDSS7-11.host.com上"></a>HDSS7-11.host.com上</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/named/od.com.zone</span><br><span class="line">k8s-yaml	60 IN A 10.4.7.200</span><br></pre></td></tr></tbody></table></figure>

<h3 id="以后所有的资源配置清单统一放置在运维主机的-data-k8s-yaml目录下即可"><a href="#以后所有的资源配置清单统一放置在运维主机的-data-k8s-yaml目录下即可" class="headerlink" title="以后所有的资源配置清单统一放置在运维主机的/data/k8s-yaml目录下即可"></a>以后所有的资源配置清单统一放置在运维主机的/data/k8s-yaml目录下即可</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# nginx -s reload</span><br></pre></td></tr></tbody></table></figure>

<h4 id="部署kube-dns-coredns"><a href="#部署kube-dns-coredns" class="headerlink" title="部署kube-dns(coredns)"></a>部署kube-dns(coredns)</h4><ul>
<li><p>准备coredns-v1.3.1镜像</p>
</li>
<li><p>运维主机HDSS7-200.host.com上：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull coredns/coredns:1.6.1</span><br><span class="line">1.3.1: Pulling from coredns/coredns</span><br><span class="line">e0daa8927b68: Pull complete </span><br><span class="line">3928e47de029: Pull complete </span><br><span class="line">Digest: sha256:02382353821b12c21b062c59184e227e001079bb13ebd01f9d3270ba0fcbf1e4</span><br><span class="line">Status: Downloaded newer image for coredns/coredns:1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag eb516548c180 harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">docker push harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/coredns]</span><br><span class="line">c6a5fc8a3f01: Pushed </span><br><span class="line">fb61a074724d: Pushed </span><br><span class="line">v1.3.1: digest: sha256:e077b9680c32be06fc9652d57f64aa54770dd6554eb87e7a00b97cf8e9431fda size: 739</span><br></pre></td></tr></tbody></table></figure>


<h3 id="任意一台运算节点上："><a href="#任意一台运算节点上：" class="headerlink" title="任意一台运算节点上："></a>任意一台运算节点上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 --docker-email=stanley.wang.m@qq.com -n kube-system</span><br></pre></td></tr></tbody></table></figure>

<h3 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><h3 id="运维主机HDSS7-200-host-com上：-3"><a href="#运维主机HDSS7-200-host-com上：-3" class="headerlink" title="运维主机HDSS7-200.host.com上："></a>运维主机HDSS7-200.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/coredns &amp;&amp; cd /data/k8s-yaml/coredns</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>RBAC</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/coredns/rbac.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io/cluster-service: "true"</span><br><span class="line">      addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - ""</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: "true"</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li> ConfigMap</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/coredns/configmap.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 {</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        ready</span><br><span class="line">        kubernetes cluster.local 192.168.0.0/16</span><br><span class="line">        forward . 10.4.7.11</span><br><span class="line">        cache 30</span><br><span class="line">        loop</span><br><span class="line">        reload</span><br><span class="line">        loadbalance</span><br><span class="line">       }</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>Deployment </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/coredns/deployment.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: coredns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: coredns</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: harbor.od.com/public/coredns:v1.6.1</span><br><span class="line">        args:</span><br><span class="line">        - -conf</span><br><span class="line">        - /etc/coredns/Corefile</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 9153</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>Service</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/coredns/svc.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    kubernetes.io/name: "CoreDNS"</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  clusterIP: 192.168.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">  - name: metrics</span><br><span class="line">    port: 9153</span><br><span class="line">    protocol: TCP</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="依次执行创建"><a href="#依次执行创建" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><h3 id="浏览器打开：http-k8s-yaml-od-com-coredns-检查资源配置清单文件是否正确创建"><a href="#浏览器打开：http-k8s-yaml-od-com-coredns-检查资源配置清单文件是否正确创建" class="headerlink" title="浏览器打开：http://k8s-yaml.od.com/coredns 检查资源配置清单文件是否正确创建"></a>浏览器打开：<a target="_blank" rel="noopener" href="http://k8s-yaml.od.com/coredns">http://k8s-yaml.od.com/coredns</a> 检查资源配置清单文件是否正确创建</h3><h3 id="在任意运算节点上应用资源配置清单"><a href="#在任意运算节点上应用资源配置清单" class="headerlink" title="在任意运算节点上应用资源配置清单"></a>在任意运算节点上应用资源配置清单</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/rbac.yaml</span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/configmap.yaml</span><br><span class="line">configmap/coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/deployment.yaml</span><br><span class="line">deployment.extensions/coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/svc.yaml</span><br><span class="line">service/coredns created</span><br></pre></td></tr></tbody></table></figure>

<h3 id="检查-3"><a href="#检查-3" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7ccccdf57c-5b9ch   1/1     Running   0          3m4s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 coredns]# kubectl get svc -n kube-system</span><br><span class="line">NAME      TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">coredns   ClusterIP   192.168.0.2   &lt;none&gt;        53/UDP,53/TCP   29s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# dig -t A nginx-ds.default.svc.cluster.local. @192.168.0.2 +short</span><br><span class="line">192.168.0.3</span><br></pre></td></tr></tbody></table></figure>

<h2 id="部署traefik（ingress）"><a href="#部署traefik（ingress）" class="headerlink" title="部署traefik（ingress）"></a>部署traefik（ingress）</h2><ul>
<li>准备traefik镜像</li>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]#  docker pull traefik:v1.7.2-alpine</span><br><span class="line">v1.7-alpine: Pulling from library/traefik</span><br><span class="line">bdf0201b3a05: Pull complete </span><br><span class="line">9dfd896cc066: Pull complete </span><br><span class="line">de06b5685128: Pull complete </span><br><span class="line">c4d82a21fa27: Pull complete </span><br><span class="line">Digest: sha256:0531581bde9da0670fc2c7a4e419e1cc38abff74e7ba06410bf2b1b55c70ef15</span><br><span class="line">Status: Downloaded newer image for traefik:v1.7-alpine</span><br><span class="line">[root@hdss7-200 ~]# docker tag 1930b7508541 harbor.od.com/k8s/traefik:v1.7       </span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/traefik:v1.7</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/traefik]</span><br><span class="line">a3e3d574f6ae: Pushed </span><br><span class="line">a7c355c1a104: Pushed </span><br><span class="line">e89059911fc9: Pushed </span><br><span class="line">a464c54f93a9: Mounted from infra/apollo-portal </span><br><span class="line">v1.7: digest: sha256:8f92899f5feb08db600c89d3016145e838fa7ff0d316ee21ecd63d9623643410 size: 1157</span><br></pre></td></tr></tbody></table></figure>

<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><h3 id="运维主机HDSS7-200-host-com上：-4"><a href="#运维主机HDSS7-200-host-com上：-4" class="headerlink" title="运维主机HDSS7-200.host.com上："></a>运维主机HDSS7-200.host.com上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/traefik &amp;&amp; cd /data/k8s-yaml/traefik</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>RBAC</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# vi /data/k8s-yaml/traefik/rbac.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - ""</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>DaemonSet </li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# vi /data/k8s-yaml/traefik/daemonset.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.od.com/public/traefik:v1.7.2</span><br><span class="line">        name: traefik-ingress</span><br><span class="line">        ports:</span><br><span class="line">        - name: controller</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 81</span><br><span class="line">        - name: admin-web</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">        args:</span><br><span class="line">        - --api</span><br><span class="line">        - --kubernetes</span><br><span class="line">        - --logLevel=INFO</span><br><span class="line">        - --insecureskipverify=true</span><br><span class="line">        - --kubernetes.endpoint=https://10.4.7.10:7443</span><br><span class="line">        - --accesslog</span><br><span class="line">        - --accesslog.filepath=/var/log/traefik_access.log</span><br><span class="line">        - --traefiklog</span><br><span class="line">        - --traefiklog.filepath=/var/log/traefik.log</span><br><span class="line">        - --metrics.prometheus</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# vi /data/k8s-yaml/traefik/svc.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-service</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: controller</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin-web</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Ingress</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# vi /data/k8s-yaml/traefik/ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">	  - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: traefik-ingress-service</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></tbody></table></figure>



<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/named/od.com.zone</span><br><span class="line">traefik	60 IN A 10.4.7.10</span><br></pre></td></tr></tbody></table></figure>


<h3 id="依次执行创建-1"><a href="#依次执行创建-1" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><h3 id="浏览器打开：http-k8s-yaml-od-com-traefik-检查资源配置清单文件是否正确创建"><a href="#浏览器打开：http-k8s-yaml-od-com-traefik-检查资源配置清单文件是否正确创建" class="headerlink" title="浏览器打开：http://k8s-yaml.od.com/traefik 检查资源配置清单文件是否正确创建"></a>浏览器打开：<a target="_blank" rel="noopener" href="http://k8s-yaml.od.com/traefik">http://k8s-yaml.od.com/traefik</a> 检查资源配置清单文件是否正确创建</h3><h3 id="在任意运算节点应用资源配置清单"><a href="#在任意运算节点应用资源配置清单" class="headerlink" title="在任意运算节点应用资源配置清单"></a>在任意运算节点应用资源配置清单</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/rbac.yaml </span><br><span class="line">serviceaccount/traefik-ingress-controller created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/daemonset.yaml </span><br><span class="line">daemonset.extensions/traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/svc.yaml </span><br><span class="line">service/traefik-ingress-service created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/ingress.yaml </span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></tbody></table></figure>

<h3 id="配置反代"><a href="#配置反代" class="headerlink" title="配置反代"></a>配置反代</h3><ul>
<li>HDSS7-11.host.com和HDSS7-12.host.com两台主机上的nginx均需要配置，这里可以考虑使用saltstack或者ansible进行统一配置管理</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/conf.d/od.com.conf</span><br><span class="line">upstream default_backend_traefik {</span><br><span class="line">    server 10.4.7.21:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">    server 10.4.7.22:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">}</span><br><span class="line">server {</span><br><span class="line">    server_name *.od.com;</span><br><span class="line">  </span><br><span class="line">    location / {</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# (umask 077; openssl  genrsa -out dashboard.od.com-key.pem)</span><br><span class="line">[root@hdss7-200 certs]# openssl req -new -key dashboard.od.com-key.pem  -out dashboard.od.com.csr -subj "/CN=dashboard.od.com/ST=Beijing/L=beijing/O=od/OU=ops"</span><br><span class="line">[root@hdss7-200 certs]# openssl   x509  -req -in dashboard.od.com.csr  -CA ca.pem  -CAkey ca-key.pem  -CAcreateserial -out dashboard.od.com.pem -days 3650</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>浏览器访问</li>
<li><a target="_blank" rel="noopener" href="http://traefik.od.com/">http://traefik.od.com</a></li>
</ul>
<h2 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h2><ul>
<li><p>准备dashboard镜像</p>
</li>
<li><p>运维主机HDSS7-200.host.com上：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull hexun/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag f9aed6605b81 harbor.od.com/k8s/dashboard:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/dashboard:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/dashboard:v1.10.1</span><br><span class="line">docker push harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/dashboard]</span><br><span class="line">23ddb8cbb75a: Pushed </span><br><span class="line">v1.10.1: digest: sha256:e76c5fe6886c99873898e4c8c0945261709024c4bea773fc477629455631e472 size: 529</span><br></pre></td></tr></tbody></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li>运维主机HDSS7-200.host.com上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/dashboard &amp;&amp; cd /data/k8s-yaml/dashboard</span><br></pre></td></tr></tbody></table></figure>


<ul>
<li>RBAC </li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/dashboard/rbac.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Secret</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/dashboard/secret.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-certs</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: Opaque</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-key-holder</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: Opaque</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>configmap </li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/dashboard/configmap.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-settings</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/dashboard/svc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>ingress</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/dashboard/ingress.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dashboard.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 443</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>deployment</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">vi /data/k8s-yaml/dashboard/deployment.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: "true"</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: ''</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: harbor.od.com/public/dashboard:v1.10.1</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">          # PLATFORM-SPECIFIC ARGS HERE</span><br><span class="line">          - --auto-generate-certificates</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: kubernetes-dashboard-certs</span><br><span class="line">          mountPath: /certs</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">            path: /</span><br><span class="line">            port: 8443</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: kubernetes-dashboard-certs</span><br><span class="line">        secret:</span><br><span class="line">          secretName: kubernetes-dashboard-certs</span><br><span class="line">      - name: tmp-volume</span><br><span class="line">        emptyDir: {}</span><br><span class="line">      serviceAccountName: kubernetes-dashboard-admin</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: "CriticalAddonsOnly"</span><br><span class="line">        operator: "Exists"</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br></pre></td></tr></tbody></table></figure>


<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><ul>
<li>HDSS7-11.host.com上</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/named/od.com.zone</span><br><span class="line">dashboard	60 IN A 10.4.7.10</span><br></pre></td></tr></tbody></table></figure>

<h3 id="依次执行创建-2"><a href="#依次执行创建-2" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><h3 id="浏览器打开：http-k8s-yaml-od-com-dashboard-检查资源配置清单文件是否正确创建"><a href="#浏览器打开：http-k8s-yaml-od-com-dashboard-检查资源配置清单文件是否正确创建" class="headerlink" title="浏览器打开：http://k8s-yaml.od.com/dashboard 检查资源配置清单文件是否正确创建"></a>浏览器打开：<a target="_blank" rel="noopener" href="http://k8s-yaml.od.com/dashboard">http://k8s-yaml.od.com/dashboard</a> 检查资源配置清单文件是否正确创建</h3><h3 id="在任意运算节点应用资源配置清单-1"><a href="#在任意运算节点应用资源配置清单-1" class="headerlink" title="在任意运算节点应用资源配置清单"></a>在任意运算节点应用资源配置清单</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac.yaml </span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-admin created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-admin created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/secret.yaml </span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/configmap.yaml </span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/svc.yaml </span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/ingress.yaml </span><br><span class="line">ingress.extensions/kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/deployment.yaml </span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>浏览器访问</li>
<li><a target="_blank" rel="noopener" href="http://dashboard.od.com/">http://dashboard.od.com</a></li>
</ul>
<h3 id="配置认证"><a href="#配置认证" class="headerlink" title="配置认证"></a>配置认证</h3><h3 id="修改nginx配置，走https"><a href="#修改nginx配置，走https" class="headerlink" title="修改nginx配置，走https"></a>修改nginx配置，走https</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/conf.d/dashboard.od.com.conf</span><br><span class="line">server {</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    rewrite ^(.*)$ https://${server_name}$1 permanent;</span><br><span class="line">}</span><br><span class="line">server {</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate "certs/dashboard.od.com.crt";</span><br><span class="line">    ssl_certificate_key "certs/dashboard.od.com.key";</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location / {</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">	      proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="获取token"><a href="#获取token" class="headerlink" title="获取token"></a>获取token</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 dashboard]# kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep kubernetes-dashboard-token | awk '{print $1}')</span><br><span class="line">Name:         kubernetes-dashboard-token-tgzcp</span><br><span class="line">Namespace:    kubernetes-dashboard</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard</span><br><span class="line">              kubernetes.io/service-account.uid: c9b84d00-2c89-4c0d-9a14-60e703c1a2b3</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1354 bytes</span><br><span class="line">namespace:  20 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi10Z3pjcCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImM5Yjg0ZDAwLTJjODktNGMwZC05YTE0LTYwZTcwM2MxYTJiMyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.dVKNm6qCrbHOfITcqYYahNAbm4rZlqF0LubXARcgAos7IFi7LDkMDTlGyu637afGEzexXsN-in3rx2_fX6rfdDPOsZsxh9YW0TovOi8uCfW13BZ5f1nFh9C0Vv9gJ1hYESTUbMlZ0DNo1FUu1qKZQhU4sWh-1dE9Gw52IofTDagGKrXCZhkw2fIa99GBdxPBkHEb3kzvsVbIavAXpZzSh9LP7vdSRwPd-fEkvNNAIC9zcgTNtwWlvILRFZhKUCTlD10BTvS0e3-CbhI8tKROL3JB7avhds7gVeGaCVeBOtEM3vJnPVmA-a31k_gDFVf6APfqul9KCdDBNa0BFjVgzg</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="部署heapster"><a href="#部署heapster" class="headerlink" title="部署heapster"></a>部署heapster</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes-retired/heapster">heapster官方github地址</a></li>
</ul>
<h3 id="准备heapster镜像"><a href="#准备heapster镜像" class="headerlink" title="准备heapster镜像"></a>准备heapster镜像</h3><h3 id="运维主机HDSS7-200-host-com上"><a href="#运维主机HDSS7-200-host-com上" class="headerlink" title="运维主机HDSS7-200.host.com上"></a>运维主机HDSS7-200.host.com上</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull quay.io/bitnami/heapster:1.5.4</span><br><span class="line">1.5.4: Pulling from bitnami/heapster</span><br><span class="line">4018396ca1ba: Pull complete </span><br><span class="line">0e4723f815c4: Pull complete </span><br><span class="line">d8569f30adeb: Pull complete </span><br><span class="line">Digest: sha256:6d891479611ca06a5502bc36e280802cbf9e0426ce4c008dd2919c2294ce0324</span><br><span class="line">Status: Downloaded newer image for quay.io/bitnami/heapster:1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker tag c359b95ad38b harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker push !$</span><br><span class="line">docker push harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/heapster]</span><br><span class="line">20d37d828804: Pushed </span><br><span class="line">b9b192015e25: Pushed </span><br><span class="line">b76dba5a0109: Pushed </span><br><span class="line">v1.5.4: digest: sha256:1203b49f2b2b07e02e77263bce8bb30563a91e1d7ee7c6742e9d125abcb3abe6 size: 952</span><br></pre></td></tr></tbody></table></figure>

<h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><ul>
<li> RBAC </li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]#vi /data/k8s-yaml/dashboard/heapster/rbac.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:heapster</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Deployment</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]#vi /data/k8s-yaml/dashboard/heapster/deployment.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bitnami/heapster/bin/heapster</span><br><span class="line">        - --source=kubernetes:https://kubernetes.default</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>Service</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]#vi /data/k8s-yaml/dashboard/heapster/svc.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span><br><span class="line">    # If you are NOT using this as an addon, you should comment out this line.</span><br><span class="line">    kubernetes.io/cluster-service: 'true'</span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">    selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></tbody></table></figure>


<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><h3 id="任意运算节点上："><a href="#任意运算节点上：" class="headerlink" title="任意运算节点上："></a>任意运算节点上：</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/rbac.yaml </span><br><span class="line">serviceaccount/heapster created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/deployment.yaml </span><br><span class="line">deployment.extensions/heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/svc.yaml </span><br><span class="line">service/heapster created</span><br></pre></td></tr></tbody></table></figure>


<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">重启dashboard</span><br><span class="line">浏览器访问：http://dashboard.od.com</span><br><span class="line">加入heapster插件的dashboard</span><br></pre></td></tr></tbody></table></figure>

<h3 id="k8s集群扩展运算节点"><a href="#k8s集群扩展运算节点" class="headerlink" title="k8s集群扩展运算节点"></a>k8s集群扩展运算节点</h3><h3 id="准备k8s的用户配置"><a href="#准备k8s的用户配置" class="headerlink" title="准备k8s的用户配置"></a>准备k8s的用户配置</h3><ul>
<li>运维主机HDSS7-200.host.com上：<ul>
<li>准备证书签发请求文件admin-csr.json </li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/opt/certs/admin-csr.json</span><br><span class="line">{</span><br><span class="line">    "CN": "cluster-admin",</span><br><span class="line">    "hosts": [</span><br><span class="line">    ],</span><br><span class="line">    "key": {</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    },</span><br><span class="line">    "names": [</span><br><span class="line">        {</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "beijing",</span><br><span class="line">            "L": "beijing",</span><br><span class="line">            "O": "od",</span><br><span class="line">            "OU": "ops"</span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>签发生产admin.pem admin-key.pem</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client   admin-csr.json |cfssl-json -bare admin</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h3 id="做kubeconfig配置"><a href="#做kubeconfig配置" class="headerlink" title="做kubeconfig配置"></a>做kubeconfig配置</h3><ul>
<li>任意运算节点上： </li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ]# scp root@hdss7-200:/opt/certs/admin.pem .</span><br><span class="line">[root@hdss7-21 ]# scp root@hdss7-200:/opt/certs/admin-key.pem .</span><br><span class="line">[root@hdss7-21 ]# scp root@hdss7-200:/opt/certs/ca.pem .</span><br><span class="line">[root@hdss7-21 ]# kubectl config set-cluster myk8s --certificate-authority=./ca.pem --embed-certs=true --server=https://10.4.7.10:7443 --kubeconfig=config</span><br><span class="line">Cluster "myk8s" set.</span><br><span class="line">[root@hdss7-21 ]# kubectl config set-credentials cluster-admin --client-certificate=./admin.pem --client-key=./admin-key.pem --embed-certs=true --kubeconfig=config</span><br><span class="line">User "cluster-admin" set.</span><br><span class="line">[root@hdss7-21 ]# kubectl config set-context myk8s-context --cluster=myk8s --user=cluster-admin --kubeconfig=config</span><br><span class="line">Context "myk8s-context" created.</span><br><span class="line">[root@hdss7-21 ]# kubectl config use-context myk8s-context --kubeconfig=config</span><br><span class="line">Switched to context "myk8s-context".</span><br><span class="line">[root@hdss7-21 ]# kubectl create clusterrolebinding myk8s-admin --clusterrole=cluster-admin --user=cluster-admin</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/myk8s-admin created</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>在扩展主机上：</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# mkdir /root/.kube</span><br><span class="line">[root@hdss7-200 certs]# cd /root/.kube/</span><br><span class="line">[root@hdss7-200 .kube]# scp hdss7-21:/root/config .</span><br><span class="line">[root@hdss7-200 .kube]# scp hdss7-21:/opt/kubernetes/server/bin/kubectl  .</span><br><span class="line">[root@hdss7-200 .kube]# ll</span><br><span class="line">total 41988</span><br><span class="line">-rw------- 1 root root     6233 Dec 31 11:16 config</span><br><span class="line">-rwxr-xr-x 1 root root 42985504 Dec 31 11:18 kubectl</span><br><span class="line">[root@hdss7-200 .kube]# mv kubectl  /usr/bin/  </span><br><span class="line">[root@hdss7-200 .kube]# which  kubectl </span><br><span class="line">/usr/bin/kubectl</span><br><span class="line">[root@hdss7-200 .kube]# kubectl  config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://10.4.7.10:7443</span><br><span class="line">  name: myk8s</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: myk8s</span><br><span class="line">    user: cluster-admin</span><br><span class="line">  name: myk8s-context</span><br><span class="line">current-context: myk8s-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences: {}</span><br><span class="line">users:</span><br><span class="line">- name: cluster-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br><span class="line">[root@hdss7-200 .kube]# </span><br><span class="line">[root@hdss7-200 .kube]# kubectl  get pods -n infra </span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">apollo-adminservice-5d59584f76-hr89v    1/1     Running   1          4d21h</span><br><span class="line">apollo-configservice-76989c4444-lrz9h   1/1     Running   0          4d21h</span><br><span class="line">apollo-portal-7cd7bf85b4-wpg26          1/1     Running   0          4d21h</span><br><span class="line">dubbo-monitor-7c79d6ffd6-rjdp8          1/1     Running   2          11d</span><br><span class="line">jenkins-7d56cdf79f-gcxxq                1/1     Running   1          5d19h</span><br><span class="line">kafka-manager-5b566f8cf8-g6bcp          1/1     Running   0          5d18h</span><br><span class="line">kibana-844848c459-95xw4                 1/1     Running   1          4d21h</span><br><span class="line">[root@hdss7-200 .kube]# </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Lustudio</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2020/12/21/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/">http://example.com/2020/12/21/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Lustudio</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/12/21/Jenkins%E8%A7%A3%E5%86%B3%E6%96%B0%E7%89%88%E6%9C%ACCSRF%E6%97%A0%E6%B3%95%E5%85%B3%E9%97%AD/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Jenkins解决新版本CSRF无法关闭</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/21/%E4%BA%A4%E4%BB%98%E6%9C%8D%E5%8A%A1%E5%88%B0kubernetes%E9%9B%86%E7%BE%A4/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">交付服务到kubernetes集群</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/12/21/ELK收集kubernetes集群日志/" title="ELK收集kubernetes集群日志"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-21</div><div class="title">ELK收集kubernetes集群日志</div></div></a></div><div><a href="/2020/12/21/交付服务到kubernetes集群/" title="交付服务到kubernetes集群"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-21</div><div class="title">交付服务到kubernetes集群</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">2.</span> <span class="toc-text">硬件环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E5%8F%B0vm%EF%BC%8C%E6%AF%8F%E5%8F%B0%E8%87%B3%E5%B0%912c2g"><span class="toc-number">2.1.</span> <span class="toc-text">- 5台vm，每台至少2c2g</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.</span> <span class="toc-text">软件环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">2.3.</span> <span class="toc-text">前置准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS%E6%9C%8D%E5%8A%A1%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2"><span class="toc-number">2.3.1.</span> <span class="toc-text">DNS服务安装部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6%E7%8E%AF%E5%A2%83"><span class="toc-number">2.3.2.</span> <span class="toc-text">准备签发证书环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85CFSSL"><span class="toc-number">2.3.3.</span> <span class="toc-text">安装CFSSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90CA%E8%AF%81%E4%B9%A6%E7%9A%84JSON%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.4.</span> <span class="toc-text">创建生成CA证书的JSON配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.5.</span> <span class="toc-text">证书类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90CA%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82%EF%BC%88csr%EF%BC%89%E7%9A%84JSON%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.6.</span> <span class="toc-text">创建生成CA证书签名请求（csr）的JSON配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90CA%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="toc-number">2.3.7.</span> <span class="toc-text">生成CA证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90ca-pem%E3%80%81ca-csr%E3%80%81ca-key-pem-CA%E7%A7%81%E9%92%A5-%E9%9C%80%E5%A6%A5%E5%96%84%E4%BF%9D%E7%AE%A1"><span class="toc-number">2.3.8.</span> <span class="toc-text">生成ca.pem、ca.csr、ca-key.pem(CA私钥,需妥善保管)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2docker%E7%8E%AF%E5%A2%83"><span class="toc-number">2.4.</span> <span class="toc-text">部署docker环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">2.4.3.</span> <span class="toc-text">启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-number">2.4.4.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2docker%E9%95%9C%E5%83%8F%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93harbor"><span class="toc-number">2.4.5.</span> <span class="toc-text">部署docker镜像私有仓库harbor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="toc-number">2.4.6.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85docker-compose"><span class="toc-number">2.5.</span> <span class="toc-text">安装docker-compose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85harbor"><span class="toc-number">2.6.</span> <span class="toc-text">安装harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5harbor%E5%90%AF%E5%8A%A8%E6%83%85%E5%86%B5"><span class="toc-number">2.6.1.</span> <span class="toc-text">检查harbor启动情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEharbor%E7%9A%84dns%E5%86%85%E7%BD%91%E8%A7%A3%E6%9E%90"><span class="toc-number">2.6.2.</span> <span class="toc-text">配置harbor的dns内网解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5"><span class="toc-number">2.6.3.</span> <span class="toc-text">检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85nginx%E5%B9%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.</span> <span class="toc-text">安装nginx并配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-1"><span class="toc-number">2.7.1.</span> <span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Master%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.8.</span> <span class="toc-text">部署Master节点服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2etcd%E9%9B%86%E7%BE%A4"><span class="toc-number">2.9.</span> <span class="toc-text">部署etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Etcd%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92"><span class="toc-number">2.9.1.</span> <span class="toc-text">Etcd集群规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82%EF%BC%88csr%EF%BC%89%E7%9A%84JSON%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.9.2.</span> <span class="toc-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BAHDSS7-200-host-com%E4%B8%8A%EF%BC%9A"><span class="toc-number">2.9.3.</span> <span class="toc-text">运维主机HDSS7-200.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90etcd%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="toc-number">2.9.4.</span> <span class="toc-text">生成etcd证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5"><span class="toc-number">2.9.5.</span> <span class="toc-text">检查生成的证书、私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAetcd%E7%94%A8%E6%88%B7"><span class="toc-number">2.9.6.</span> <span class="toc-text">创建etcd用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%EF%BC%8C%E8%A7%A3%E5%8E%8B%EF%BC%8C%E5%81%9A%E8%BD%AF%E8%BF%9E%E6%8E%A5"><span class="toc-number">2.9.7.</span> <span class="toc-text">下载软件，解压，做软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-12-host-com%E4%B8%8A%EF%BC%9A"><span class="toc-number">2.9.8.</span> <span class="toc-text">HDSS7-12.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95%EF%BC%8C%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5"><span class="toc-number">2.9.9.</span> <span class="toc-text">创建目录，拷贝证书、私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%94%9F%E6%88%90%E7%9A%84ca-pem%E3%80%81etcd-peer-key-pem%E3%80%81etcd-peer-pem%E6%8B%B7%E8%B4%9D%E5%88%B0-opt-etcd-certs%E7%9B%AE%E5%BD%95%E4%B8%AD%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90600"><span class="toc-number">2.9.10.</span> <span class="toc-text">将运维主机上生成的ca.pem、etcd-peer-key.pem、etcd-peer.pem拷贝到&#x2F;opt&#x2F;etcd&#x2F;certs目录中，注意私钥文件权限600</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAetcd%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">2.9.11.</span> <span class="toc-text">创建etcd服务启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%9D%83%E9%99%90%E5%92%8C%E7%9B%AE%E5%BD%95"><span class="toc-number">2.9.12.</span> <span class="toc-text">调整权限和目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85supervisor%E8%BD%AF%E4%BB%B6"><span class="toc-number">2.9.13.</span> <span class="toc-text">安装supervisor软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAetcd-server%E7%9A%84%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">2.9.14.</span> <span class="toc-text">创建etcd-server的启动配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8etcd%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">2.9.15.</span> <span class="toc-text">启动etcd服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84etcd%E6%9C%8D%E5%8A%A1-%E7%95%A5"><span class="toc-number">2.9.16.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的etcd服务    略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E5%8F%B0%E5%9D%87%E5%90%AF%E5%8A%A8%E5%90%8E%EF%BC%8C%E6%A3%80%E6%9F%A5%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">2.10.</span> <span class="toc-text">3台均启动后，检查集群状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-apiserver%E9%9B%86%E7%BE%A4"><span class="toc-number">2.10.1.</span> <span class="toc-text">部署kube-apiserver集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92"><span class="toc-number">2.10.2.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E9%87%8C%E9%83%A8%E7%BD%B2%E6%96%87%E6%A1%A3%E4%BB%A5HDSS7-21-host-com%E4%B8%BB%E6%9C%BA%E4%B8%BA%E4%BE%8B%EF%BC%8C%E5%8F%A6%E5%A4%96%E4%B8%80%E5%8F%B0%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E6%96%B9%E6%B3%95%E7%B1%BB%E4%BC%BC"><span class="toc-number">2.10.3.</span> <span class="toc-text">这里部署文档以HDSS7-21.host.com主机为例，另外一台运算节点安装部署方法类似</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%EF%BC%8C%E8%A7%A3%E5%8E%8B%EF%BC%8C%E5%81%9A%E8%BD%AF%E8%BF%9E%E6%8E%A5-1"><span class="toc-number">2.10.4.</span> <span class="toc-text">下载软件，解压，做软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%8F%91client%E8%AF%81%E4%B9%A6"><span class="toc-number">2.10.5.</span> <span class="toc-text">签发client证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82%EF%BC%88csr%EF%BC%89%E7%9A%84JSON%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-1"><span class="toc-number">2.10.6.</span> <span class="toc-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90client%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="toc-number">2.10.7.</span> <span class="toc-text">生成client证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.10.8.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%8F%91kube-apiserver%E8%AF%81%E4%B9%A6"><span class="toc-number">2.10.9.</span> <span class="toc-text">签发kube-apiserver证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82%EF%BC%88csr%EF%BC%89%E7%9A%84JSON%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-2"><span class="toc-number">2.10.10.</span> <span class="toc-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90kube-apiserver%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="toc-number">2.10.11.</span> <span class="toc-text">生成kube-apiserver证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5-1"><span class="toc-number">2.10.12.</span> <span class="toc-text">检查生成的证书、私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E8%87%B3%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B9%B6%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">2.10.13.</span> <span class="toc-text">拷贝证书至各运算节点，并创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7600"><span class="toc-number">2.10.14.</span> <span class="toc-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">2.10.15.</span> <span class="toc-text">创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">2.10.16.</span> <span class="toc-text">创建启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%9D%83%E9%99%90%E5%92%8C%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.10.17.</span> <span class="toc-text">调整权限和目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsupervisor%E9%85%8D%E7%BD%AE"><span class="toc-number">2.10.18.</span> <span class="toc-text">创建supervisor配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">2.10.19.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84kube-apiserver-%E7%95%A5"><span class="toc-number">2.10.20.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的kube-apiserver    略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D4%E5%B1%82%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">2.11.</span> <span class="toc-text">配4层反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE"><span class="toc-number">2.11.1.</span> <span class="toc-text">nginx配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#keepalived%E9%85%8D%E7%BD%AE"><span class="toc-number">2.11.2.</span> <span class="toc-text">keepalived配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived%E4%B8%BB"><span class="toc-number">2.12.</span> <span class="toc-text">keepalived主</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-11-host-com%E4%B8%8A"><span class="toc-number">2.12.1.</span> <span class="toc-text">HDSS7-11.host.com上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#keepalived%E5%A4%87"><span class="toc-number">2.12.2.</span> <span class="toc-text">keepalived备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-12-host-com%E4%B8%8A"><span class="toc-number">2.12.3.</span> <span class="toc-text">HDSS7-12.host.com上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E4%BB%A3%E7%90%86%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">2.12.4.</span> <span class="toc-text">启动代理并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-11-host-com-HDSS7-12-host-com%E4%B8%8A%EF%BC%9A"><span class="toc-number">2.12.5.</span> <span class="toc-text">HDSS7-11.host.com,HDSS7-12.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-2"><span class="toc-number">2.12.6.</span> <span class="toc-text">启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5-1"><span class="toc-number">2.12.7.</span> <span class="toc-text">检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2controller-manager"><span class="toc-number">2.13.</span> <span class="toc-text">部署controller-manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC-1"><span class="toc-number">2.13.1.</span> <span class="toc-text">创建启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A"><span class="toc-number">2.13.2.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="toc-number">2.13.3.</span> <span class="toc-text">调整文件权限，创建目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsupervisor%E9%85%8D%E7%BD%AE-1"><span class="toc-number">2.13.4.</span> <span class="toc-text">创建supervisor配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-1"><span class="toc-number">2.13.5.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5-1"><span class="toc-number">2.13.6.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-2"><span class="toc-number">2.13.7.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-scheduler"><span class="toc-number">2.14.</span> <span class="toc-text">部署kube-scheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92-1"><span class="toc-number">2.14.1.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC-2"><span class="toc-number">2.14.2.</span> <span class="toc-text">创建启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-3"><span class="toc-number">2.14.3.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95-1"><span class="toc-number">2.14.4.</span> <span class="toc-text">调整文件权限，创建目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-4"><span class="toc-number">2.14.5.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsupervisor%E9%85%8D%E7%BD%AE-2"><span class="toc-number">2.14.6.</span> <span class="toc-text">创建supervisor配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-5"><span class="toc-number">2.14.7.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5-2"><span class="toc-number">2.14.8.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-6"><span class="toc-number">2.14.9.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84kube-scheduler%E6%9C%8D%E5%8A%A1-%E7%95%A5"><span class="toc-number">2.14.10.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的kube-scheduler服务   略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2Node%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">部署Node节点服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kubelet"><span class="toc-number">3.1.</span> <span class="toc-text">部署kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92-2"><span class="toc-number">3.1.1.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%8F%91kubelet%E8%AF%81%E4%B9%A6"><span class="toc-number">3.1.2.</span> <span class="toc-text">签发kubelet证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BAHDSS7-200-host-com%E4%B8%8A%EF%BC%9A-1"><span class="toc-number">3.1.3.</span> <span class="toc-text">运维主机HDSS7-200.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82%EF%BC%88csr%EF%BC%89%E7%9A%84JSON%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-3"><span class="toc-number">3.1.4.</span> <span class="toc-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90kubelet%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="toc-number">3.1.5.</span> <span class="toc-text">生成kubelet证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5-2"><span class="toc-number">3.1.6.</span> <span class="toc-text">检查生成的证书、私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E8%87%B3%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B9%B6%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE-1"><span class="toc-number">3.1.7.</span> <span class="toc-text">拷贝证书至各运算节点，并创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-7"><span class="toc-number">3.1.8.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7600-1"><span class="toc-number">3.1.9.</span> <span class="toc-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE-1"><span class="toc-number">3.1.10.</span> <span class="toc-text">创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99kubectl%E5%88%9B%E5%BB%BA%E8%BD%AF%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.1.11.</span> <span class="toc-text">给kubectl创建软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-cluster"><span class="toc-number">3.1.12.</span> <span class="toc-text">set-cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-credentials"><span class="toc-number">3.1.13.</span> <span class="toc-text">set-credentials</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-context"><span class="toc-number">3.1.14.</span> <span class="toc-text">set-context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#use-context"><span class="toc-number">3.1.15.</span> <span class="toc-text">use-context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.16.</span> <span class="toc-text">创建资源配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.17.</span> <span class="toc-text">应用资源配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5-2"><span class="toc-number">3.1.18.</span> <span class="toc-text">检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubectl%E5%91%BD%E4%BB%A4%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8"><span class="toc-number">3.1.19.</span> <span class="toc-text">kubectl命令自动补全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87pause%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F"><span class="toc-number">3.1.20.</span> <span class="toc-text">准备pause基础镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E8%87%B3%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%EF%BC%88harbor%EF%BC%89%E4%B8%AD"><span class="toc-number">3.1.21.</span> <span class="toc-text">提交至私有仓库（harbor）中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E7%99%BB%E5%BD%95%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93"><span class="toc-number">3.1.22.</span> <span class="toc-text">配置主机登录私有仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%99%E9%87%8C%E4%BB%A3%E8%A1%A8%EF%BC%9A%E7%94%A8%E6%88%B7%E5%90%8Dadmin%EF%BC%8C%E5%AF%86%E7%A0%81Harbor12345"><span class="toc-number">3.1.23.</span> <span class="toc-text">这里代表：用户名admin，密码Harbor12345</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%99%E9%95%9C%E5%83%8F%E6%89%93tag"><span class="toc-number">3.1.24.</span> <span class="toc-text">给镜像打tag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAkubelet%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">3.1.25.</span> <span class="toc-text">创建kubelet启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-8"><span class="toc-number">3.1.26.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95"><span class="toc-number">3.1.27.</span> <span class="toc-text">检查配置，权限，创建日志目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-9"><span class="toc-number">3.1.28.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsupervisor%E9%85%8D%E7%BD%AE-3"><span class="toc-number">3.1.29.</span> <span class="toc-text">创建supervisor配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5-3"><span class="toc-number">3.1.30.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-10"><span class="toc-number">3.1.31.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9"><span class="toc-number">3.1.32.</span> <span class="toc-text">检查运算节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-proxy"><span class="toc-number">3.2.</span> <span class="toc-text">部署kube-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92-3"><span class="toc-number">3.2.1.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BAHDSS7-200-host-com%E4%B8%8A%EF%BC%9A-2"><span class="toc-number">3.2.2.</span> <span class="toc-text">运维主机HDSS7-200.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E7%AD%BE%E5%90%8D%E8%AF%B7%E6%B1%82%EF%BC%88csr%EF%BC%89%E7%9A%84JSON%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-4"><span class="toc-number">3.2.3.</span> <span class="toc-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90kube-proxy%E8%AF%81%E4%B9%A6%E5%92%8C%E7%A7%81%E9%92%A5"><span class="toc-number">3.2.4.</span> <span class="toc-text">生成kube-proxy证书和私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%94%9F%E6%88%90%E7%9A%84%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5-3"><span class="toc-number">3.2.5.</span> <span class="toc-text">检查生成的证书、私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E8%87%B3%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B9%B6%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE-2"><span class="toc-number">3.2.6.</span> <span class="toc-text">拷贝证书至各运算节点，并创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E3%80%81%E7%A7%81%E9%92%A5%EF%BC%8C%E6%B3%A8%E6%84%8F%E7%A7%81%E9%92%A5%E6%96%87%E4%BB%B6%E5%B1%9E%E6%80%A7600-2"><span class="toc-number">3.2.7.</span> <span class="toc-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE-2"><span class="toc-number">3.2.8.</span> <span class="toc-text">创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-cluster-1"><span class="toc-number">3.2.9.</span> <span class="toc-text">set-cluster</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%9C%A8conf%E7%9B%AE%E5%BD%95%E4%B8%8B"><span class="toc-number">3.2.10.</span> <span class="toc-text">注意：在conf目录下</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#set-credentials-1"><span class="toc-number">3.2.10.1.</span> <span class="toc-text">set-credentials</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-context-1"><span class="toc-number">3.2.11.</span> <span class="toc-text">set-context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#use-context-1"><span class="toc-number">3.2.12.</span> <span class="toc-text">use-context</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%9C%A8conf%E7%9B%AE%E5%BD%95%E4%B8%8B-1"><span class="toc-number">3.2.13.</span> <span class="toc-text">注意：在conf目录下</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BDipvs%E6%A8%A1%E5%9D%97"><span class="toc-number">3.2.14.</span> <span class="toc-text">加载ipvs模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bipvs%E7%8A%B6%E6%80%81"><span class="toc-number">3.2.15.</span> <span class="toc-text">查看ipvs状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAkube-proxy%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.16.</span> <span class="toc-text">创建kube-proxy启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95-1"><span class="toc-number">3.2.17.</span> <span class="toc-text">检查配置，权限，创建日志目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsupervisor%E9%85%8D%E7%BD%AE-4"><span class="toc-number">3.2.18.</span> <span class="toc-text">创建supervisor配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5-4"><span class="toc-number">3.2.19.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ipvs"><span class="toc-number">3.2.20.</span> <span class="toc-text">ipvs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84kube-proxy%E6%9C%8D%E5%8A%A1-%E7%95%A5"><span class="toc-number">3.2.21.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的kube-proxy服务   略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2addons%E6%8F%92%E4%BB%B6"><span class="toc-number">4.</span> <span class="toc-text">部署addons插件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81kubernetes%E9%9B%86%E7%BE%A4"><span class="toc-number">4.1.</span> <span class="toc-text">验证kubernetes集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%BB%BB%E6%84%8F%E4%B8%80%E4%B8%AA%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E8%BF%99%E9%87%8C%E6%88%91%E4%BB%AC%E9%80%89%E6%8B%A9HDSS7-21-host-com%E4%B8%BB%E6%9C%BA"><span class="toc-number">4.1.1.</span> <span class="toc-text">在任意一个运算节点，创建一个资源配置清单这里我们选择HDSS7-21.host.com主机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%B9%B6%E6%A3%80%E6%9F%A5"><span class="toc-number">4.1.2.</span> <span class="toc-text">应用资源配置，并检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2flannel"><span class="toc-number">4.2.</span> <span class="toc-text">部署flannel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92-4"><span class="toc-number">4.2.1.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%B8%8A%E5%A2%9E%E5%8A%A0iptables%E8%A7%84%E5%88%99"><span class="toc-number">4.2.2.</span> <span class="toc-text">在各运算节点上增加iptables规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96SNAT%E8%A7%84%E5%88%99%EF%BC%8C%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%B9%8B%E9%97%B4%E7%9A%84%E5%90%84POD%E4%B9%8B%E9%97%B4%E7%9A%84%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1%E4%B8%8D%E5%86%8D%E5%87%BA%E7%BD%91"><span class="toc-number">4.2.3.</span> <span class="toc-text">优化SNAT规则，各运算节点之间的各POD之间的网络通信不再出网</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-7-21%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84%EF%BC%8C%E6%9D%A5%E6%BA%90%E6%98%AF172-7-21-0-24%E6%AE%B5%E7%9A%84docker%E7%9A%84ip%EF%BC%8C%E7%9B%AE%E6%A0%87ip%E4%B8%8D%E6%98%AF172-7-0-0-16%E6%AE%B5%EF%BC%8C%E7%BD%91%E7%BB%9C%E5%8F%91%E5%8C%85%E4%B8%8D%E4%BB%8Edocker0%E6%A1%A5%E8%AE%BE%E5%A4%87%E5%87%BA%E7%AB%99%E7%9A%84%EF%BC%8C%E6%89%8D%E8%BF%9B%E8%A1%8CSNAT%E8%BD%AC%E6%8D%A2"><span class="toc-number">4.2.4.</span> <span class="toc-text">10.4.7.21主机上的，来源是172.7.21.0&#x2F;24段的docker的ip，目标ip不是172.7.0.0&#x2F;16段，网络发包不从docker0桥设备出站的，才进行SNAT转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%BF%9D%E5%AD%98iptables%E8%A7%84%E5%88%99"><span class="toc-number">4.2.5.</span> <span class="toc-text">各运算节点保存iptables规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%EF%BC%8C%E8%A7%A3%E5%8E%8B%EF%BC%8C%E5%81%9A%E8%BD%AF%E8%BF%9E%E6%8E%A5-2"><span class="toc-number">4.2.6.</span> <span class="toc-text">下载软件，解压，做软连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%B7%E8%B4%9D%E8%AF%81%E4%B9%A6%E5%88%B0fanneld%E7%9B%AE%E5%BD%95%E4%B8%8Bcert"><span class="toc-number">4.2.7.</span> <span class="toc-text">拷贝证书到fanneld目录下cert</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">4.2.8.</span> <span class="toc-text">最终目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9Cetcd%EF%BC%8C%E5%A2%9E%E5%8A%A0host-gw"><span class="toc-number">4.2.9.</span> <span class="toc-text">操作etcd，增加host-gw</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE-3"><span class="toc-number">4.2.10.</span> <span class="toc-text">创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC-3"><span class="toc-number">4.2.11.</span> <span class="toc-text">创建启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-11"><span class="toc-number">4.2.12.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9Aflannel%E9%9B%86%E7%BE%A4%E5%90%84%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC%E7%95%A5%E6%9C%89%E4%B8%8D%E5%90%8C%EF%BC%8C%E9%83%A8%E7%BD%B2%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E6%97%B6%E6%B3%A8%E6%84%8F%E4%BF%AE%E6%94%B9%E3%80%82"><span class="toc-number">4.2.13.</span> <span class="toc-text">注意：flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%EF%BC%8C%E6%9D%83%E9%99%90%EF%BC%8C%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9B%AE%E5%BD%95-2"><span class="toc-number">4.2.14.</span> <span class="toc-text">检查配置，权限，创建日志目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-21-host-com%E4%B8%8A%EF%BC%9A-12"><span class="toc-number">4.2.15.</span> <span class="toc-text">HDSS7-21.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAsupervisor%E9%85%8D%E7%BD%AE-5"><span class="toc-number">4.2.16.</span> <span class="toc-text">创建supervisor配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%B9%B6%E6%A3%80%E6%9F%A5-5"><span class="toc-number">4.2.17.</span> <span class="toc-text">启动服务并检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%90%AF%E5%8A%A8%E6%A3%80%E6%9F%A5%E6%89%80%E6%9C%89%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%9A%84flannel%E6%9C%8D%E5%8A%A1%E7%95%A5"><span class="toc-number">4.2.18.</span> <span class="toc-text">安装部署启动检查所有集群规划主机上的flannel服务略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2k8s%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E7%9A%84%E5%86%85%E7%BD%91http%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.2.19.</span> <span class="toc-text">部署k8s资源配置清单的内网http服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%86%85%E7%BD%91DNS%E8%A7%A3%E6%9E%90"><span class="toc-number">4.2.20.</span> <span class="toc-text">配置内网DNS解析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HDSS7-11-host-com%E4%B8%8A-1"><span class="toc-number">4.2.21.</span> <span class="toc-text">HDSS7-11.host.com上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E5%90%8E%E6%89%80%E6%9C%89%E7%9A%84%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E7%BB%9F%E4%B8%80%E6%94%BE%E7%BD%AE%E5%9C%A8%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BA%E7%9A%84-data-k8s-yaml%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%8D%B3%E5%8F%AF"><span class="toc-number">4.2.22.</span> <span class="toc-text">以后所有的资源配置清单统一放置在运维主机的&#x2F;data&#x2F;k8s-yaml目录下即可</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-dns-coredns"><span class="toc-number">4.2.22.1.</span> <span class="toc-text">部署kube-dns(coredns)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E4%B8%80%E5%8F%B0%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%B8%8A%EF%BC%9A"><span class="toc-number">4.2.23.</span> <span class="toc-text">任意一台运算节点上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">4.2.24.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BAHDSS7-200-host-com%E4%B8%8A%EF%BC%9A-3"><span class="toc-number">4.2.25.</span> <span class="toc-text">运维主机HDSS7-200.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9B%E5%BB%BA"><span class="toc-number">4.2.26.</span> <span class="toc-text">依次执行创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%EF%BC%9Ahttp-k8s-yaml-od-com-coredns-%E6%A3%80%E6%9F%A5%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%E5%88%9B%E5%BB%BA"><span class="toc-number">4.2.27.</span> <span class="toc-text">浏览器打开：http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;coredns 检查资源配置清单文件是否正确创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%BB%BB%E6%84%8F%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%B8%8A%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">4.2.28.</span> <span class="toc-text">在任意运算节点上应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5-3"><span class="toc-number">4.2.29.</span> <span class="toc-text">检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2traefik%EF%BC%88ingress%EF%BC%89"><span class="toc-number">4.3.</span> <span class="toc-text">部署traefik（ingress）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-1"><span class="toc-number">4.3.1.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BAHDSS7-200-host-com%E4%B8%8A%EF%BC%9A-4"><span class="toc-number">4.3.2.</span> <span class="toc-text">运维主机HDSS7-200.host.com上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D"><span class="toc-number">4.3.3.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9B%E5%BB%BA-1"><span class="toc-number">4.3.4.</span> <span class="toc-text">依次执行创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%EF%BC%9Ahttp-k8s-yaml-od-com-traefik-%E6%A3%80%E6%9F%A5%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%E5%88%9B%E5%BB%BA"><span class="toc-number">4.3.5.</span> <span class="toc-text">浏览器打开：http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;traefik 检查资源配置清单文件是否正确创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%BB%BB%E6%84%8F%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">4.3.6.</span> <span class="toc-text">在任意运算节点应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%8F%8D%E4%BB%A3"><span class="toc-number">4.3.7.</span> <span class="toc-text">配置反代</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">4.3.8.</span> <span class="toc-text">生成证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2dashboard"><span class="toc-number">4.4.</span> <span class="toc-text">部署dashboard</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-2"><span class="toc-number">4.4.1.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%9F%9F%E5%90%8D-1"><span class="toc-number">4.4.2.</span> <span class="toc-text">解析域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%88%9B%E5%BB%BA-2"><span class="toc-number">4.4.3.</span> <span class="toc-text">依次执行创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%EF%BC%9Ahttp-k8s-yaml-od-com-dashboard-%E6%A3%80%E6%9F%A5%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%E5%88%9B%E5%BB%BA"><span class="toc-number">4.4.4.</span> <span class="toc-text">浏览器打开：http:&#x2F;&#x2F;k8s-yaml.od.com&#x2F;dashboard 检查资源配置清单文件是否正确创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E4%BB%BB%E6%84%8F%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-1"><span class="toc-number">4.4.5.</span> <span class="toc-text">在任意运算节点应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AE%A4%E8%AF%81"><span class="toc-number">4.4.6.</span> <span class="toc-text">配置认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9nginx%E9%85%8D%E7%BD%AE%EF%BC%8C%E8%B5%B0https"><span class="toc-number">4.4.7.</span> <span class="toc-text">修改nginx配置，走https</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96token"><span class="toc-number">4.4.8.</span> <span class="toc-text">获取token</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2heapster"><span class="toc-number">4.5.</span> <span class="toc-text">部署heapster</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87heapster%E9%95%9C%E5%83%8F"><span class="toc-number">4.5.1.</span> <span class="toc-text">准备heapster镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%BB%B4%E4%B8%BB%E6%9C%BAHDSS7-200-host-com%E4%B8%8A"><span class="toc-number">4.5.2.</span> <span class="toc-text">运维主机HDSS7-200.host.com上</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95-3"><span class="toc-number">4.5.3.</span> <span class="toc-text">准备资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E8%B5%84%E6%BA%90%E9%85%8D%E7%BD%AE%E6%B8%85%E5%8D%95"><span class="toc-number">4.5.4.</span> <span class="toc-text">应用资源配置清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9%E4%B8%8A%EF%BC%9A"><span class="toc-number">4.5.5.</span> <span class="toc-text">任意运算节点上：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E9%9B%86%E7%BE%A4%E6%89%A9%E5%B1%95%E8%BF%90%E7%AE%97%E8%8A%82%E7%82%B9"><span class="toc-number">4.5.6.</span> <span class="toc-text">k8s集群扩展运算节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87k8s%E7%9A%84%E7%94%A8%E6%88%B7%E9%85%8D%E7%BD%AE"><span class="toc-number">4.5.7.</span> <span class="toc-text">准备k8s的用户配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%9Akubeconfig%E9%85%8D%E7%BD%AE"><span class="toc-number">4.5.8.</span> <span class="toc-text">做kubeconfig配置</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Lustudio</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>